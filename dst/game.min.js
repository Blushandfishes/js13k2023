function h(){for(this.ui=[],this.tree=new V(16,23,0,0,0,P.TREE,"",1.5),this.tree.ui=!0,this.rock=new V(16,16,0,0,0,P.ROCK,"",1.5),this.rock.ui=!0,ms=[[-75,P.HAM],[-161,P.SWD],[13,P.AX],[99,P.HAND]],i=0;i<ms.length;i++)this.ui.push(new V(16,16,$/2+ms[i][0],_-88,0,P.UI,"",4,0,!0,ms[i][1])),this.ui.push(new V(10,10,$/2+ms[i][0]+14,_-80,0,ms[i][1],"",4,!0));for(this.ui[7].sx=96,this.ui[7].sy=0,i=0;i<5;i++)this.ui.push(new V(16,16,20+32*i,0,0,P.HP,"",4,!0));this.ui.push(new V(6,16,212,0,0,P.HPE,"",4,!0)),m=new V(6,16,0,0,0,P.HPE,"",4,!0),m.flip=!0,this.ui.push(m),this.tick=function(){this.ui.forEach(t=>{t.type==P.UI&&ct&&Y(t.hb,rt)&&(ct=!1,wt.hero.setWeapon(t.weapon))})}}var n,o=!1,a=!1,l={songData:[{i:[2,96,128,0,2,8,164,0,0,5,12,44,43,0,0,0,0,69,3,1,1,26,116,0,32,0,6,76,6],p:[1,3,1,4,5,6,7,8],c:[{n:[147,,,,,,,,150,,,,,,,,149,,,,,,150,149,147,,,,,,145],f:[]},{n:[],f:[]},{n:[147,,,,,,145,147,149,,,,,,147,145,147],f:[]},{n:[147,,,,,,145,147,149,,,,,,150,152,154,,,,,,,,153],f:[]},{n:[154,,,,,,,,157,,,,,,156,157,159,,,,,,,,154,,,,,,152],f:[]},{n:[154,,,,,,,,157,,,,,,156,157,159,,,,,,,,,,,,,,161],f:[]},{n:[162,,,,,,,,,,,,,,161,162,164,,,,,,,,,,,,,,161,164],f:[]},{n:[166,,,,,,,,,,,,,,,173,173],f:[]}]},{i:[3,61,128,0,3,63,128,0,0,9,17,40,72,0,0,0,1,178,7,0,2,255,15,0,32,83,8,84,8],p:[11,12,11,14,13,13,15,16],c:[{n:[],f:[]},{n:[147,,,,147,,,,147,,,,147,,,,147,,,,147,,,,147,,,,147],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[135,,,,,,,,,,,,,,,,135,,,,,,,,,,,,,,,,138,,,,,,,,,,,,,,,,140,,,,,,,,,,,,,,,,142,,,,,,,,,,,,,,,,144],f:[]},{n:[131,,,,,,,,133,,,,,,,,135,,,,,,,,,,,,,,,,135,,,,,,,,137,,,,,,,,139,,,,,,,,,,,,,,,,138,,,,,,,,140,,,,,,,,142],f:[]},{n:[142,,,,,,,,,,,,,,,,142,,,,,,,,,,,,,,,,145,,,,,,,,,,,,,,,,147,,,,,,,,,,,,,,,,149,,,,,,,,,,,,,,,,151],f:[]},{n:[131,,,,,,,,133,,,,,,,,138,,,,,,,,137,,,,,,,,135,,,,,,,,137,,,,,,,,142,,,,,,,,141,,,,,,,,138,,,,,,,,140,,,,,,,,145,,,,,,,,144],f:[]},{n:[138,,,,,,,,,,,,,,,,140,,,,,,,,,,,,,,,,142,,,,,,,,,,,,,,,,144,,,,,,,,,,,,,,,,145,,,,,,,,,,,,,,,,147],f:[]},{n:[142,,,,,,,,,,,,,,,,142,,,,,,,,,,,,,,,,147,,,,,,,,,,,,,,,,146,,,,,,,,,,,,,,,,149,,,,,,,,,,,,,,,,149],f:[]}]},{i:[1,0,128,0,1,0,128,9,0,37,13,5,20,0,0,0,0,0,0,0,2,255,0,0,32,47,3,0,1],p:[17,17,17,17,17,17,17,17],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[147,,147,147,147,,147,147,147,,147,147,147,,147,147,147,,147,147,147,,147,147,147,,147,147,147,,147,147],f:[]}]},{i:[0,99,116,79,0,53,116,0,83,0,4,6,69,52,0,0,0,0,0,0,2,14,0,0,32,0,0,0,0],p:[18,18,18,18,18,18,18,18],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[135,,,,135,,,,137,,,,135,,,,135,,,,135,,,,135,,,,135],f:[]}]},{i:[2,83,128,0,3,182,128,0,0,0,0,6,29,0,0,0,0,0,0,0,3,5,184,119,244,147,6,0,0],p:[19,20,19,21,22,22,23,24],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[111,,111,111,111,,111,111,111,,111,111,111,,111,,104,,104,104,104,,104,104,104,,104,104,104,,106],f:[]},{n:[107,,107,107,107,,107,107,109,,109,109,109,,109,109,111,,111,111,111,,111,111,111,,111,111,111,,111],f:[]},{n:[107,,107,107,107,,107,107,109,,109,109,109,,109,109,114,,114,114,114,,114,114,113,,113,113,113,114,115,116],f:[]},{n:[118,,118,118,118,,118,118,118,,118,118,118,,118,,111,,111,111,111,,111,111,111,,111,111,111,113,114,116],f:[]},{n:[114,,114,114,114,,114,114,114,,114,114,114,,114,114,116,,116,116,116,,116,116,116,,116,116,116,,116],f:[]},{n:[118,,118,118,118,,118,118,118,,118,118,118,,113,,118,,118,118,118,,118,118,118,,118,118,118,116,114,113],f:[]}]}],rowLen:4562,patternLen:32,endPattern:7,numChannels:5},u=function(){var t,e,s,i,h,n=function(t){return Math.sin(6.283184*t)},o=function(t){return.003959503758*2**((t-128)/12)},a=function(t,e,s){var i,h,n,a,c,l,u=r[t.i[0]],f=t.i[1],p=t.i[3]/32,d=r[t.i[4]],y=t.i[5],x=t.i[8]/32,w=t.i[9],m=t.i[10]*t.i[10]*4,v=t.i[11]*t.i[11]*4,g=t.i[12]*t.i[12]*4,b=1/g,k=-t.i[13]/16,S=t.i[14],M=s*2**(2-t.i[15]),T=new Int32Array(m+v+g),E=0,A=0;for(i=0,h=0;i<m+v+g;i++,h++)h>=0&&(h-=M,c=o(e+(15&(S=S>>8|(255&S)<<4))+t.i[2]-128),l=o(e+(15&S)+t.i[6]-128)*(1+8e-4*t.i[7])),n=1,i<m?n=i/m:i>=m+v&&(n=(1-(n=(i-m-v)*b))*3**(k*n)),a=u(E+=c*n**p)*f,a+=d(A+=l*n**x)*y,w&&(a+=(2*Math.random()-1)*w),T[i]=80*a*n|0;return T},r=[n,function(t){return t%1<.5?1:-1},function(t){return t%1*2-1},function(t){var e=t%1*4;return e<2?e-1:3-e}];this.init=function(n){t=n,e=n.endPattern,s=0,i=n.rowLen*n.patternLen*(e+1)*2,h=new Int32Array(i)},this.generate=function(){var o,c,l,u,f,p,d,y,x,w,m,v,g,b,k=new Int32Array(i),S=t.songData[s],M=t.rowLen,T=t.patternLen,E=0,A=0,H=!1,P=[];for(l=0;l<=e;++l)for(d=S.p[l],u=0;u<T;++u){var R=d?S.c[d-1].f[u]:0;R&&(S.i[R-1]=S.c[d-1].f[u+T]||0,R<17&&(P=[]));var D=r[S.i[16]],W=S.i[17]/512,L=2**(S.i[18]-9)/M,C=S.i[19],z=S.i[20],I=43.23529*S.i[21]*3.141592/44100,j=1-S.i[22]/255,N=1e-5*S.i[23],O=S.i[24]/32,Y=S.i[25]/512,B=6.283184*2**(S.i[26]-9)/M,X=S.i[27]/255,K=S.i[28]*M&-2;for(m=(l*T+u)*M,f=0;f<4;++f)if(p=d?S.c[d-1].n[u+f*T]:0){P[p]||(P[p]=a(S,p,M));var G=P[p];for(c=0,o=2*m;c<G.length;c++,o+=2)k[o]+=G[c]}for(c=0;c<M;c++)(w=k[y=2*(m+c)])||H?(v=I,C&&(v*=D(L*y)*W+.5),A+=(v=1.5*Math.sin(v))*(g=j*(w-A)-(E+=v*A)),w=3==z?A:1==z?g:E,N&&(w=(w*=N)<1?w>-1?n(.25*w):-1:1,w/=N),H=(w*=O)*w>1e-5,b=w*(1-(x=Math.sin(B*y)*Y+.5)),w*=x):b=0,y>=K&&(b+=k[y-K+1]*X,w+=k[y-K]*X),k[y]=0|b,k[y+1]=0|w,h[y]+=0|b,h[y+1]+=0|w}return++s/t.numChannels},this.createAudioBuffer=function(t){for(var e=t.createBuffer(2,i/2,44100),s=0;s<2;s++)for(var n=e.getChannelData(s),o=s;o<i;o+=2)n[o>>1]=h[o]/65536;return e},this.createWave=function(){var t=44+2*i-8,e=t-36,s=new Uint8Array(44+2*i);s.set([82,73,70,70,255&t,t>>8&255,t>>16&255,t>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&e,e>>8&255,e>>16&255,e>>24&255]);for(var n=0,o=44;n<i;++n){var a=h[n];a=a<-32767?-32767:a>32767?32767:a,s[o++]=255&a,s[o++]=a>>8&255}return s},this.getData=function(t,e){for(var s=2*Math.floor(44100*t),i=new Array(e),n=0;n<2*e;n+=1){var o=s+n;i[n]=t>0&&o<h.length?h[o]/32768:0}return i}},f;function p(){var t=new u;t.init(l),setInterval(function(){if(!o&&(o=t.generate()>=1)){var e=t.createWave();(n=document.createElement("audio")).src=URL.createObjectURL(new Blob([e],{type:"audio/wav"})),a=!0}},0)}function d(t,e,s,i,h,n,o,a=Nt){}function y(t=0,e=0){this.x=t,this.y=e}var x=[];function w(t,e){for(m=f.createBuffer(1,96e3,48e3),gainNode=f.createGain(),b=m.getChannelData(0),i=96e3;i--;)b[i]=getSound(t,i);s=f.createBufferSource(),s.buffer=m,s.connect(gainNode),gainNode.connect(f.destination),gainNode.gain.value=e,s.start()}function v(e){if(t=((t,e)=>(e-t)/e),e>7e4)return null;t(e,7e4);return Math.sin(.001*e*Math.sin(.009*e)+Math.sin(e/100))}function g(t){if(t>1e4)return null;var e=(1e4-t)/1e4;return(128&Math.pow(t,1.055)?1:-1)*Math.pow(e,2)}function k(t){if(t>5e4)return null;var e=(5e4-t)/5e4;return(200&Math.pow(t,.9)?1:-1)*Math.pow(e,3)}function S(t){var e=1e4;if(t>e)return null;var s=(e-t)/e,i=Math.pow(s,2.1);return Math.pow(t,3)&(t<3333.3333333333335?16:99)?i:-i}function M(t){if(t>2e4)return null;var e=(2e4-t)/2e4;return Math.sin(.003*-t*Math.sin(.09*t+Math.sin(t/200))+Math.sin(t/100))*e*e}function T(t){if(t>1e4)return null;var e=(1e4-t)/1e4;return Math.sin(.01*t*Math.sin(.009*t+Math.sin(t/200))+Math.sin(t/100))*e*e}function E(e){if(e>2e3)return null;t=((t,e)=>(e-t)/e);var s=t(e,2e3);return 33&Math.pow(50*e,.7)?s:-s}function A(e){if(t=((t,e)=>(e-t)/e),e>2e4)return null;var s=t(e,2e4);return e*=.04,Math.sin(.03*-e*Math.sin(.09*e+Math.sin(e/200))+Math.sin(e/100))*s}function H(){var t=!0;this.cam=new y,this.ratio=1,this.tips=!0,this.time=0,this.ratio=$>800?$/800:_/600,this.scale=2,this.cube=16,this.scaled=this.scale*this.cube,this.hero=new Z(16,16,0,0,0,P.HERO,this.scale),this.introT=0,this.shake=0,this.shakeTime=0,this.reset=!1,this.wait=2,this.genLevel=function(t){this.levels=[];for(let t=1;t<=10;t++){var e=new Q(1,$,_,this.scale);e.reset(t,this.scaled),this.levels.push(e)}},this.setLevel=function(t){this.level=this.levels[t],this.hero.e.curLevel=t,this.hero.e.x=this.level.startPos[0],this.hero.e.y=this.level.startPos[1],this.level.objs.push(this.hero.e)},this.nextLevel=function(){this.setLevel(dt),dt++},this.genLevel(0),this.setLevel(0),this.menu=new h,this.update=function(e,s,h=!1){if(this.time+=e/1e3,t&&(t=!1,ctx.scale(this.ratio,this.ratio)),this.shake=xt?Math.cos(ht):0,wt.shakeTime>0&&(wt.shakeTime-=e/1e3),this.hero.setCurrentTile(this.scaled),!h){for(this.level.draw(this.hero,e),this.hero.update(ctx,e),this.menu.ui.forEach(t=>t.update(e)),this.menu.tick(),i=0;i<this.level.trees;i++)this.menu.tree.x=8+30*i,this.menu.tree.y=150,this.menu.tree.update(e);for(i=0;i<this.level.rocks;i++)this.menu.rock.x=8+30*i,this.menu.rock.y=190,this.menu.rock.update(e)}this.level.mobs.forEach(t=>t.update(e)),this.cam.x=U(400-this.hero.e.x-20,this.cam.x,.8),this.cam.y=U(300-this.hero.e.y-80,this.cam.y,.8),this.level.objs=this.level.objs.filter(function(t){return t.hp>=0}),this.level.mobs=this.level.mobs.filter(function(t){return t.e.hp>=0})}}getSound=function(t,e){var s;switch(t){case se:s=v(e);break;case ie:s=S(e);break;case he:s=g(e);break;case ne:s=k(e);break;case oe:s=M(e);break;case ae:s=T(e);break;case re:s=E(e);break;case ce:s=A(e);break;default:return 1}return s};const P={AIR:0,GRASS:1,HERO:2,BRDE:3,WTR:4,SEA:5,SND:6,TREE:7,ROCK:8,CST:9,CNE:10,UI:11,HAM:12,SWD:13,AX:14,HP:15,HPE:16,HAND:17,SKELLY:18},R={FOLLOW:0,SIMPLE:1};function D(t,e,s,i,h,n,o,a,r,c){this.id=t,this.obj=null,this.up=L(a,r,colz,colz),i+=this.up,this.drop=W(a,r,colz,colz),this.e=new V(e,e,s,i,h,n,"",c,0,0),this.up>=0&&n==P.GRASS?(this.e.sx=16,this.e.sy=16):-12==this.up&&n==P.GRASS&&(this.e.sx=32,this.e.sy=16),this.column=a,this.row=r,this.active=!0,n==P.GRASS&&(this.e.y-=4),n==P.SND&&(this.e.y+=2),this.progress=!1,this.oscillationSpeed=.8,this.oscillationAmount=7,this.initialY=this.e.y,this.e.y=this.e.y+this.drop,this.update=function(t){if(this.e.y=U(this.e.y,this.initialY,.08),this.e.type==P.SEA){let t=.001*Date.now(),e=Math.sin(t*this.oscillationSpeed+this.column)*this.oscillationAmount;this.e.offsetY=0,this.e.y=this.initialY+e}this.e.update(t)},this.isTile=function(){return!0}}function W(t,e,s,i){const h=s/2,n=i/2,o=Math.min(s,i)/3,a=(t-h)*(t-h)+(e-n)*(e-n);return-(500*Math.exp(-a/(2*o*o)))}function L(t,e,s,i){const h=s/2,n=i/2,o=Math.min(s,i)/4,a=Math.min(s,i)/3,r=2*(Math.random()-.5),c=t+r,l=e+r,u=Math.sqrt((c-h)*(c-h)+(l-n)*(l-n));return u<o?-24:u<a?-12:0}function C(t,e,s,i){this.x=t,this.y=e,this.w=s,this.h=i}function I(){let t="#";for(var e=0;e<6;e++)t+="0123456789ABCDEF"[Math.floor(16*Math.random())];return t}function j(t,e){return Math.floor(Math.random()*(e-t+1)+t)}function N(t){return new C(t.x,t.y,t.w,t.h)}function O(t,e,s,i,h,n,o,a){return t<h+o&&t+s>h&&e<n+a&&e+i>n}function Y(t,e){return t.x<e.x+e.w&&t.x+t.w>e.x&&t.y<e.y+e.h&&t.y+t.h>e.y}function B(t,e){this.x=t,this.y=e,this.set=function(t,e){this.x=t,this.y=e}}function X(t,e,s,i,h,n,o,a,r){t.save(),t.globalAlpha=r,t.translate(e,s),t.fillStyle=a,t.fillRect(i,h,n,o),t.restore()}function K(){}function G(t){var e=j(0,360)*Math.PI/180,s=j(50,180),i=[-1,1][j(0,1)]*s;return{x:t.x+i*Math.cos(e),y:t.y+i*Math.sin(e)}}function U(t,e,s){return(1-s)*t+s*e}function F(t,e){const s=Math.floor(t/2),i=Math.floor(e/2);return{x:16*(s-i)/2,y:16*(s+i)/2}}function q(t,e,s,i){let h=t/32,n=(e+2*s+i)/32*2,o=n-h,a=h+n;return r=Math.floor(o),c=Math.floor(a),J(r,c)}function J(t,e){return wt.level.tiles[e+wt.levels[wt.hero.e.curLevel].cols*t]}function Q(t,e,s,i){this.tiles=[],this.objs=[],this.mobs=[],this.castle=[],this.active=!1,this.startPos=[-120,280],this.cols=colz,this.rotate=!1,this.rocks=0,this.trees=0,this.complete=!1,this.bridge=!1,this.mobTime=0,this.cen=F(colz-1,colz-1),this.respawnDelay=5;let h=0;this.draw=function(t,e,s){this.tiles.forEach(t=>t.update(e,s)),this.objs.sort((t,e)=>t.y-e.y),this.rocks=0,this.trees=0,this.objs.forEach(t=>{t.update(e),t.update(e,!0),t.type==P.ROCK&&this.rocks++,t.type==P.TREE&&this.trees++}),this.castle.forEach(t=>t.update(e)),t.tool.type!=P.HAND&&t.tool.update(e),t.e.y>290&&a(t.e.x,t.e.y,F(colz-1,colz-1))&&t.e.update(e),this.rotate&&(!function(t,e){let s=colz;for(let e=0;e<s;e++)for(let i=e+1;i<s;i++){let h=t.level.tiles[e*s+i],n=t.level.tiles[i*s+e];o(h,n)}for(let e=0;e<s;e++)for(let i=0;i<s/2;i++){let h=t.level.tiles[e*s+i],n=t.level.tiles[e*s+(s-i-1)];o(h,n)}}(wt,this.objs),this.rotate=!1),0==this.mobs.length&&0==this.rocks&&0==this.trees&&(this.complete=!0);for(let t=0;t<this.mobs.length;t++)this.mobs[t].update(e,this.mobs);if(this.complete&&!this.bridge){this.bridge=!0;let t=colz/2;for(r=0;r<3;r++)for(c=1;c<7;c++){let e=J(t+r,colz-c);e.e.type=P.BRDE,c<3&&(e.progress=!0),e.e.setType(),e.e.y=200,e.initialY-=5}}this.mobTime+=e/1e3,this.mobTime>this.respawnDelay&&(this.trees>0||this.rocks>0)&&(this.mobTime=0,skelly=new le(16,16,this.cen.x,this.cen.y,0,P.SKELLY,i,10),this.mobs.push(skelly),this.objs.push(skelly.e))},this.reset=function(t,e){console.log("RESET"),this.tiles=[],this.dTiles=[],h=0;let s=j(2,5),o=0,l=colz,u=0;for(r=0;r<l;r++)for(c=0;c<this.cols;c++){let t=1;r<4||c<4||c>colz-4||r>colz-4?t=P.SEA:(r<6||c<6||c>colz-6||r>colz-6)&&j(0,100)>50?t=P.SEA:(r<8||c<8||c>colz-8||r>colz-8)&&j(0,100)>20?t=P.SND:j(0,100)>99&&o<s&&(t=P.WTR,o++),xx=16*(c-r),yy=8*(c+r);var f=new D(u,16,xx,yy,0,t,!1,c,r,i);this.tiles.push(f),u++}const p=[];this.tiles.forEach((t,e)=>{t.e.type==P.WTR&&Array.from({length:j(3,8)},(t,e)=>e).forEach(e=>{Array.from({length:j(3,5)},(t,e)=>e).forEach(s=>{let i=(t.row+e)*colz+(t.column+s);i>=0&&i<this.tiles.length&&p.push(i)})})}),p.forEach(t=>{j(0,100)>20&&this.tiles[t].e.type!=P.WTR&&(this.tiles[t].e.type=P.WTR,this.tiles[t].e.setType(),this.tiles[t].initialY+=6)}),maxTrees=2+t,maxRocks=1+t,this.tiles.forEach(t=>{t.e.type==P.GRASS&&j(0,100)>98&&this.trees<maxTrees?a(t.e.x,t.e.y-t.drop-10-30,this.cen)||(obj=new V(16,23,t.e.x,t.e.y-t.drop-10-30,0,P.TREE,"",i,!1,2),obj.parent=t,t.obj=obj,this.objs.push(obj),this.trees++):t.e.type==P.GRASS&&j(0,100)>98&&this.rocks<maxRocks&&(a(t.e.x,t.e.y-t.drop-10,this.cen)||(obj=new V(16,16,t.e.x,t.e.y-t.drop-10,0,P.ROCK,"",i,!1,4),obj.parent=t,t.obj=obj,this.objs.push(obj),this.rocks++))}),skelly=new le(16,16,this.cen.x,this.cen.y,0,P.SKELLY,i,10),this.mobs.push(skelly),this.objs.push(skelly.e);let d=this.cen.x,y=this.cen.y;n(this.castle,d+5,y-86,4,0,16,!0,P.CST,!0),n(this.castle,d-10,y-64,1,0,16),n(this.castle,d-26,y-56,1,0,16),n(this.castle,d-41,y-64,4,0,16,!0,P.CST,!0),n(this.castle,d+22,y-64,1,0,-16,!1),n(this.castle,d+38,y-56,1,0,-16,!1),n(this.castle,d+54,y-64,4,0,16,!0,P.CST,!0),n(this.castle,d+38,y-24,2,0,-16,!1),n(this.castle,d+22,y-18,2,0,-16,!1),n(this.castle,d-26,y-8,3,0,-16,!1),n(this.castle,d-10,y,3,0,-16,!1),n(this.castle,d+6,y-40,4,0,16,!0,P.CST,!0)};const n=(t,e,s,h,n=0,o=8,a=!0,r=P.CST,c=!1)=>{const l=a?t=>t>=0:t=>t<h,u=a?t=>--t:t=>++t;for(let c=a?h-1:0;l(c);c=u(c))t.push(new V(16,16,e+n*c,s+o*c,0,r,"",i,!1,0));c&&t.push(new V(16,16,e+n,s+o-20,0,P.CNE,"",i,!1,0))};function o(t,e){let s=t.e.type;t.initialY;t.e.type=e.e.type,e.e.type=s,t.e.setType(),e.e.setType(),t.e.z=e.e.z}function a(t,e,s){const i=[-90,s.y-100],h=[90,s.y+20];return t>=i[0]&&t<=h[0]&&e>=i[1]&&e<=h[1]}}function V(t,e,i,h,n,o,a,r,c=!1,l=0,u=0){this.weapon=u,this.scale=r,this.type=o,this.width=t,this.height=e,this.mhWidth=t/-2,this.mhHeight=e/-2,this.mhWScld=t/-2*r,this.mhHScld=e/-2*r,this.hWidth=t/2,this.hHeight=e/2,this.cenX=i-this.mhWScld,this.cenY=h-this.mhHScld,this.angle=n,this.x=i,this.y=h,this.z=0,this.active=!0,this.colour=a,this.image=yt,this.animated=!1,this.alpha=1,this.currentTile=0,this.colArr=[],this.isSolid=!1,this.isButton=c,this.time=0,this.maxHP=l,this.hp=this.maxHP,this.flip=!1,this.idle=0,this.chk=!1,this.offsetY=0,this.parent=null,this.wet=!1,this.ui=!1,this.sx=0,this.sy=0,this.setHitbox=function(){this.hb=new C(0,0,0,0),this.sensor=new C(0,0,0,0),this.isButton&&(this.hb.w=2*this.width*this.scale,this.hb.h=2*this.height*this.scale)},this.setHitbox(),this.updateHitbox=function(){this.isButton?(this.hb.x=this.x-this.width,this.hb.y=this.y-this.height):(this.hb.x=this.x+this.scale/2,this.hb.y=this.y+this.scale/2,this.hb.w=this.width*this.scale-this.scale-10,this.hb.h=this.height*this.scale-this.scale,this.sensor.x=this.x-5,this.sensor.y=this.y-5,this.sensor.w=this.width*this.scale+10,this.sensor.h=this.height*this.scale+10)},this.update=function(i,h=!1){if(this.idle+=i/1e3,this.updateHitbox(),this.active){if(ctx.save(),ctx.translate(this.x,this.y-this.z),ctx.globalAlpha=this.alpha,img=this.image,s=this.scale,mhw=this.mhWidth,mhh=this.mhHeight,hw=this.hWidth,hh=this.hHeight,t=this.width,e=this.height,wt.shakeTime>0&&ctx.translate(wt.shake,wt.shake),this.ui)ctx.setTransform(1,0,0,1,0,0),this.flip&&(ctx.scale(-1,1),ctx.translate(-t*s,0)),ctx.drawImage(img,this.sx,this.sy,t,e,this.x,this.y,t*s,e*s);else if(ctx.translate(wt.cam.x,wt.cam.y),null==this.image)ctx.fillStyle=this.colour,ctx.fillRect(.5*mhw*s,.5*mhh*s,.5*t*s,.5*e*s);else{if(this.flip?(ctx.scale(-1,1),ctx.translate(-t*s-t,0)):ctx.scale(1,1),z=0,this.angle>0){let t=24;ctx.translate(t,t),ctx.rotate(this.angle*Math.PI/180),ctx.translate(-t,-t)}if(this.wet&&(e-=2),this.isHero()&&!h){if(wt.hero.hands.forEach(t=>{ctx.drawImage(img,t.sx,t.sy,t.width,t.height,t.x,t.y,t.width*t.scale,t.height*t.scale)}),wt.hero.dance&&(ctx.shadowColor="gold",ctx.shadowBlur=10),ctx.drawImage(img,this.sx,this.sy,t,e,hw+z,hh,t*s,e*s),wt.hero.renderPower){ctx.globalAlpha=wt.hero.wepPower>2?wt.hero.wepPower/10:0;let i=wt.hero.wepPower<10,h=wt.hero.facing==Nt?t*s-10:t*s-20,n=10-e;wt.hero.facing!=Nt&&(ctx.scale(-1,1),ctx.translate(-t*s,0)),ctx.beginPath(),ctx.arc(h,n,20,Math.PI,2*Math.PI),ctx.lineWidth=i?10:15;let o=ctx.createLinearGradient(h-20,n,h+20,n);o.addColorStop(0,i?"#0a910f":"#fff"),o.addColorStop(wt.hero.wepPower/10,"#db6532");let a=wt.hero.wepPower/10+.01>1?1:wt.hero.wepPower/10+.01;o.addColorStop(a,i?"#06062e":"#db6532"),ctx.strokeStyle=o,ctx.stroke()}}else if(h){ctx.scale(1,-1),ctx.shadowColor="#000",ctx.shadowBlur=8,ctx.globalAlpha=this.isHero()&&this.wet?.3:.08;let i=this.isHero()?4:3.8;ctx.drawImage(img,this.sx,this.sy,t,e,hw+z,-i*e,t*s,e*s)}else ctx.drawImage(img,this.sx,this.sy,t,e,hw+z,hh,t*s,e*s)}ctx.restore()}this.cenX=this.x-this.mhWScld,this.cenY=this.y-this.mhHScld},this.isHero=function(){return this.type==P.HERO},this.isTile=function(){return!1},this.setT=function(t){this.type=t,this.setType()},this.setType=function(){switch(this.alpha=1,this.sy=0,this.sx=0,this.isSolid=!1,this.type){case P.HERO:this.isSolid=!0,this.sx=0,this.sy=0;break;case P.GRASS:this.sx=16;break;case P.BRDE:this.sx=32;break;case P.WTR:case P.SEA:this.sx=48;break;case P.AIR:this.sx=144;break;case P.SND:this.sy=16;break;case P.TREE:this.isSolid=!0,this.sx=80;break;case P.ROCK:this.isSolid=!0,this.sx=64;break;case P.CST:this.isSolid=!0,this.sx=64,this.sy=16;break;case P.CNE:this.sx=48,this.sy=16;break;case P.UI:this.ui=!0,this.sy=32;break;case P.HAM:this.sx=16,this.sy=33,this.ui=!0;break;case P.SWD:this.sx=26,this.sy=33,this.ui=!0;break;case P.AX:this.sx=36,this.sy=32,this.ui=!0;break;case P.HP:this.sx=48,this.sy=32,this.ui=!0;break;case P.HPE:this.sx=64,this.sy=32,this.ui=!0;break;case P.HAND:this.sx=71,this.sy=42,this.ui=!0;break;case P.SKELLY:this.sx=96,this.sy=16}},this.setType()}function Z(t,e,s,i,h,n,o){this.e=new V(t,e,s,i,h,n,"",o,!1,100),this.e.z=24,this.active=!0,this.hp=2,this.particles=[];let a=null,r=null,c=0,l=Nt,u=(this.e.x,this.e.y,0),f=0,p=0,d=0;this.time=0,this.deaths=0,this.moved=!1,this.tool=new V(10,10,s,i,0,P.HAND,"",o),this.tool.setType(),this.wepPower=0,this.attackTime=0,this.renderPower=!1,this.facing=l,this.attackOver=!1,this.dance=!1,this.axePower=1,this.hammerPower=1;let y=0;this.punchProgress=0;let x=!1,m="idle";this.hState=m,this.hands=[],this.hands.push(new V(4,4,s,i,0,P.HAND,"",o,!1)),this.hands.push(new V(4,4,s,i,0,P.HAND,"",o,!1)),this.update=function(t,e){this.time+=e/1e3,this.moved=!1,this.active&&(this.curTile&&this.curTile.progress&&(console.log("Move to next island"),wt.nextLevel()),Et()||At()||Ht()||Pt()?(u+=e,this.moved=!0):(c=0,u=0),Ht()&&(this.e.y-=this.gMove(0,-1)),Pt()&&(this.e.y+=this.gMove(0,1)),Et()&&(this.e.x-=this.gMove(-1,0),"punch"!=m&&"retracting"!=m&&(this.e.flip=!0,l=jt)),At()&&(this.e.x+=this.gMove(1,0),"punch"!=m&&"retracting"!=m&&(this.e.flip=!1,l=Nt)),Wt()&&this.tool!=P.SWD&&this.setWeapon(P.SWD),Lt()&&this.tool!=P.HAM&&this.setWeapon(P.HAM),Ct()&&this.tool!=P.AX&&this.setWeapon(P.AX,!0),zt()&&this.tool!=P.HAND&&this.setWeapon(P.HAND));for(let s=0;s<=this.particles.length-1;s++)this.particles[s].update(t,e);this.punchDistance=65,this.punchSpeed=5;const s=this.e.wet?-6:0,i=this.moved?.01:.003,h=1.7*Math.sin(this.time*i),n=1.7*Math.sin(this.time*i+Math.PI);if(this.hands[0].x=30,this.hands[1].x=9,this.hands[0].y=this.moved?29+n+s:29+h+s,this.hands[1].y=29+h+s,this.e.idle>10||this.dance||this.moved){let t=.6*Math.sin(15*this.time);this.moved||(this.e.z+=t),this.hands[0].y-=6*t,this.hands[1].y+=6*t,this.e.idle>15&&(this.e.idle=0)}if(this.setWeaponX(e),this.setWeaponY(),!Rt()||"idle"!=m&&"spin"!=m&&"swipe"!=m)switch(x&&(this.punchProgress+=this.punchSpeed,this.hands[1].x=this.punchProgress,this.hands[1].scale+=.1,this.tool.scale+=.1,m="punch",this.punchProgress>=this.punchDistance&&(m="retracting",x=!1,this.wepPower=0)),m){case"idle":this.wepPower=0,this.attackOver=!1;break;case"swipe":m="retracting"}else switch(m){case"idle":m=this.tool.type==P.HAND?"spin":"swipe";break;case"spin":y+=.8,this.hands[1].x+=4*Math.cos(y),this.hands[1].y+=4*Math.sin(y),y>=2*Math.PI&&(y=0,x=!0,this.punchProgress=0),this.chargeUp()}if(this.wepPower>=10?(wt.shakeTime=.1,this.dance=!0):this.dance=!1,p=this.e.x-this.e.mhWScld,d=this.e.y-this.e.mhHScld,this.hState=m,this.attackTime>0||this.punchProgress>0){let t=l==Nt?20:-20;hb=new C(this.e.x+t,this.e.y,this.e.width,this.e.height),wt.level.objs.forEach(t=>{if(t.type!=P.HERO&&!this.attackOver&&Y(hb,t.hb))switch(t.type){case P.TREE:this.tool.type==P.AX&&(t.hp-=this.axePower,this.attackOver=!0),wt.shakeTime=.15;break;case P.ROCK:this.tool.type==P.HAM&&(t.hp-=this.hammerPower,this.attackOver=!0),wt.shakeTime=.1;break;case P.SKELLY:t.parent.hit(e,this.tool.type,this.wepPower),wt.shakeTime=.1,this.attackOver=!0}})}this.renderPower=!("spin"!=m&&"swipe"!=m||this.tool.type!=P.HAND&&this.tool.type!=P.SWD),this.facing=l},this.reset=function(){this.done=!1,this.particles=[],this.hp=2;let t=wt.levels[this.e.curLevel];this.e.x=t.startPos[0],this.e.y=t.startPos[1]},this.kill=function(){this.active&&(this.deaths++,wt.shakeTime=.15,w(ae,1),this.hp--,this.active=!1,f=.5,c=0,this.e.sy=16,0==this.hp&&this.hp++)},this.setCurrentTile=function(t){this.moved&&(r=a,(a=q(this.e.x,this.e.y,this.e.height,this.e.z))&&r&&a.id!==r.id&&r.up!==a.up&&(this.e.z=.25*-a.up)),null!=a&&(a.e.type==P.WTR?(c=1,this.e.wet=!0):a.e.type==P.SEA?(c=.25,this.e.wet=!0):(c=3,this.e.wet=!1)),this.curTile=a},this.addDust=function(t=!1){u=0},this.setWeaponX=function(t){switch(this.tool.type){case P.SWD:"idle"==m&&(this.tool.angle=l==Nt?80:45),"swipe"==m&&(this.chargeUp(),l==Nt?this.tool.angle>10&&(this.tool.angle-=3):this.tool.angle<90&&(this.tool.angle+=3)),"retracting"==m&&this.retract(),this.tool.x=this.e.x+this.hands[1].x+1;break;case P.HAM:"idle"==m&&(this.tool.angle=l==Nt?70:30),"swipe"==m&&(this.tool.angle=this.tool.angle=l==Nt?30:70,this.hands[0].y-=10,this.hands[1].y-=7),"retracting"==m&&this.retract(),this.tool.x=l==Nt?this.e.x+this.hands[1].x+1:this.e.x+this.hands[1].x-20,this.hands[1].x=30;break;case P.AX:"idle"==m&&(this.tool.angle=30),"swipe"==m&&(this.tool.angle=90,this.hands[0].y-=10,this.hands[1].y-=7),"retracting"==m&&this.retract(),this.tool.flip=l==Nt,this.hands[1].x=30,this.tool.x=l==Nt?this.e.x+this.hands[0].x+1:this.e.x+this.hands[0].x-40;break;case P.HAND:"retracting"==m&&(this.punchProgress-=this.punchSpeed,this.hands[1].x=this.punchProgress,this.hands[1].scale-=.1,this.tool.scale-=.1,this.punchProgress<=0&&(this.punchProgress=0,m="idle"))}},this.setWeaponY=function(){if("idle"==m||"swipe"==m){let t=l==Nt?0:1;this.tool.y=this.hands[t].y+this.e.y-this.e.z-17}},this.chargeUp=function(){this.wepPower=this.wepPower>=10?10:this.wepPower+=.25,this.wepPower},this.retract=function(){let t=l==Nt?1:0;this.tool.y=this.hands[t].y+this.e.y-this.e.z-17,this.tool.type==P.AX?this.tool.angle=330:this.tool.type==P.HAM?this.tool.angle=l==Nt?120:330:this.tool.type==P.SWD&&(this.tool.angle=l==Nt?U(this.tool.angle,120,.8):330),this.attackTime>.2?(m="idle",this.attackTime=0):this.attackTime+=et/1e3},this.setWeapon=function(t,e=!1){"idle"==m&&(this.tool.type=t,this.tool.setType(),this.tool.flip=e,this.tool.ui=!1)},this.gMove=function(t,e,s=!1,i=!1){this.e.idle=0,rec=N(this.e.hb),rec.w=20,rec.h=10,rec.x+=t*c,rec.y+=e*c/2,canMove=!0;for(var h=0;h<wt.level.objs.length;h++)if(obj=wt.level.objs[h],null!=obj&&Y(obj.hb,rec)&&2!=obj.type&&obj.isSolid){canMove=!1;break}return canMove?0!=e?c/2:c:0}}let $=window.innerWidth,_=window.innerHeight,tt=!1,et=0,st=Date.now(),it=Date.now(),ht=0,nt=0,ot=new B(0,0),at=new B(0,0),rt=new C(0,0,0,0),ct=!1,lt=!1,ut=!1,ft="990099",pt=!1,dt=1;colz=40+2*dt;let yt=new Image;yt.src="atlas.png";let xt=!0,wt=new H,mt=!1,vt=!0,gt=!1;function startGame(){bt.start()}p();let bt={canvas:document.createElement("canvas"),start:function(){this.canvas.width=$,this.canvas.height=_,this.context=this.canvas.getContext("2d"),this.context.scale(1,1),ctx=this.context,ctx.mozImageSmoothingEnabled=!1,ctx.webkitImageSmoothingEnabled=!1,ctx.imageSmoothingEnabled=!1,this.canvas.classList.add("screen"),document.body.insertBefore(this.canvas,document.body.childNodes[6]),this.frameNo=0,this.interval=setInterval(kt,20),window.addEventListener("keydown",function(t){mt=!0,t.preventDefault(),bt.keys=bt.keys||[],bt.keys[t.keyCode]="keydown"==t.type}),window.addEventListener("keyup",function(t){bt.keys[t.keyCode]="keydown"==t.type,t.keyCode==te&&(ut=!0),t.keyCode==Ut&&(gt=!gt),t.keyCode==ee&&(wt.tips=!wt.tips)}),window.addEventListener("mouseup",function(t){t.preventDefault(),It(),ct=!0}),window.addEventListener("mousemove",function(t){t.preventDefault();var e=bt.canvas.getBoundingClientRect();ot.set((t.clientX-e.left)/(e.right-e.left)*$,(t.clientY-e.top)/(e.bottom-e.top)*_)}),this.canvas.oncontextmenu=function(t){t.preventDefault()}},stop:function(){clearInterval(this.interval)},clear:function(){this.context.clearRect(0,0,4*this.canvas.width,4*this.canvas.height)}};function kt(){if(lt&&(ht=0,lt=!1,pt=!1,dt=0,mt=!1,tt=!1,wt.genLevel(dt)),mt&&(null!=wt.hero&&(wt.hero.e.active=!0),tt=!0,null==f&&(f=new AudioContext)),st=it,it=Date.now(),ht+=et=it-st,tt){bt.clear(),wt.update(et,ht,!1);let t="30px Papyrus";Tt(ctx,1,t,"WHITE","[M] Music: "+!gt,$-230,30),Tt(ctx,1,t,"WHITE","[R] Reset Level",$-230,70),Tt(ctx,1,t,"WHITE","Level: "+(wt.hero.e.curLevel+1),10,100),Tt(ctx,1,t,"WHITE","Castle Resources:",10,140),wt.hero.curTile&&Tt(ctx,1,t,"WHITE","Row: "+wt.hero.curTile.row+" Col: "+wt.hero.curTile.column,10,400),Tt(ctx,1,t,"WHITE","STAGE: "+dt,10,450);wt.hero.e.curLevel;gt&&(n.pause(),vt=!0),vt&&o&&!gt&&(n.play(),n.loop=!0,vt=!1)}else{bt.clear(),ctx=bt.context,wt.update(et,ht,!0),ctx.save(),St(ctx,.1,"#"+ft,0,0,$,_),Tt(ctx,1,"30px Papyrus","WHITE","Main Screen",30,40),ctx.restore()}ct=!1}function St(t,e,s,i,h,n,o){t.save(),t.setTransform(1,0,0,1,0,0),t.globalAlpha=e,t.fillStyle=s,t.fillRect(i,h,n,o),t.restore()}function Mt(t,e,s,i,h,n,o){var a=eval('"\\u'+h+'"');t.globalAlpha=e,t.font=s,t.fillStyle=i,t.fillText(a,n,o)}function Tt(t,e,s,i,h,n,o){t.save(),t.setTransform(1,0,0,1,0,0),t.globalAlpha=e,t.font=s,t.fillStyle=i,t.fillText(h,n,o),t.restore()}function Et(){return bt.keys&&(bt.keys[jt]||bt.keys[Xt])}function At(){return bt.keys&&(bt.keys[Nt]||bt.keys[Gt])}function Ht(){return bt.keys&&(bt.keys[Ot]||bt.keys[Bt])}function Pt(){return bt.keys&&(bt.keys[Yt]||bt.keys[Kt])}function Rt(){return bt.keys&&bt.keys[Jt]}function Dt(){return bt.keys&&bt.keys[Ut]}function Wt(){return bt.keys&&bt.keys[Vt]}function Lt(){return bt.keys&&bt.keys[Zt]}function Ct(){return bt.keys&&bt.keys[$t]}function zt(){return bt.keys&&bt.keys[_t]}function It(){at.set(ot.x,ot.y),rt.x=ot.x-5,rt.y=ot.y+5,rt.h=10,rt.w=10}var jt=37,Nt=39,Ot=38,Yt=40,Bt=87,Xt=65,Kt=83,Gt=68,Ut=77,Ft=0,qt=2,Jt=32,Qt=69,Vt=49,Zt=50,$t=51,_t=52,te=82,ee=84,se=0,ie=1,he=2,ne=3,oe=4,ae=5,re=6,ce=7;function le(t,s,i,h,n,o,a,r){this.e=new V(t,s,i,h,n,o,"",a,!1,r),this.e.parent=this,this.type=R.FOLLOW,this.bspd=150,this.spd=.5,this.noX=!1,this.noY=!1,this.waitX=1,this.waitY=1,this.time=0,this.tryXSpeed=this.spd,this.tryYSpeed=this.spd,this.facing=Nt,this.hit=function(t,e,s){this.e.hp-=1+s},this.update=function(t){this.time+=t/1e3;let s=this.e.x,i=this.e.y;e=this.e;let h=this.steerFromNearbyMobs(wt.level.mobs,26);e.y=i<wt.hero.e.y?i+=this.spd/2+h.y:i+=-this.spd/2+h.y,e.x=s<wt.hero.e.x?s+=this.spd+h.x:s+=-this.spd+h.x,this.e.x>wt.hero.e.x?this.e.flip=!0:this.e.flip=!1},this.steerFromNearbyMobs=function(t,e){let s=0,i=0,h=0;for(let n=0;n<t.length;n++){let o=t[n],a=Math.sqrt(Math.pow(this.e.x-o.e.x,2)+Math.pow(this.e.y-o.e.y,2));o!==this&&a<e&&(s+=this.e.x-o.e.x,i+=this.e.y-o.e.y,h++)}h>0&&(s/=h,i/=h);let n=Math.sqrt(s*s+i*i);return n>0&&(s/=n,i/=n),{x:s,y:i}}}
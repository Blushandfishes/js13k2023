function t(){for(this.ui=[],this.tree=new O(16,23,0,0,0,y.TREE,"",1.2),this.tree.ui=!0,this.rock=new O(16,16,0,0,0,y.ROCK,"",1.5),this.rock.ui=!0,ms=[[-75,y.HAM],[-161,y.SWD],[13,y.AX],[99,y.HAND]],i=0;i<ms.length;i++)this.ui.push(new O(16,16,G/2+ms[i][0],N-96,0,y.UI,"",4,0,!0,ms[i][1])),this.ui.push(new O(10,10,G/2+ms[i][0]+14,N-88,0,ms[i][1],"",4,!0));for(this.ui[7].sx=96,this.ui[7].sy=0,i=0;i<5;i++)this.ui.push(new O(16,16,20+32*i,0,0,y.HP,"",4,!0));this.ui.push(new O(6,16,212,0,0,y.HPE,"",4,!0)),m=new O(6,16,0,0,0,y.HPE,"",4,!0),m.flip=!0,this.ui.push(m),this.tick=function(){this.ui.forEach(t=>{t.type==y.UI&&Q&&T(t.hb,J)&&(Q=!1,ht.hero.setWeapon(t.weapon))})}}var h,a=!1,n=!1,o={songData:[{i:[2,96,128,0,2,8,164,0,0,5,12,44,43,0,0,0,0,69,3,1,1,26,116,0,32,0,6,76,6],p:[1,3,1,4,5,6,7,8],c:[{n:[147,,,,,,,,150,,,,,,,,149,,,,,,150,149,147,,,,,,145],f:[]},{n:[],f:[]},{n:[147,,,,,,145,147,149,,,,,,147,145,147],f:[]},{n:[147,,,,,,145,147,149,,,,,,150,152,154,,,,,,,,153],f:[]},{n:[154,,,,,,,,157,,,,,,156,157,159,,,,,,,,154,,,,,,152],f:[]},{n:[154,,,,,,,,157,,,,,,156,157,159,,,,,,,,,,,,,,161],f:[]},{n:[162,,,,,,,,,,,,,,161,162,164,,,,,,,,,,,,,,161,164],f:[]},{n:[166,,,,,,,,,,,,,,,173,173],f:[]}]},{i:[3,61,128,0,3,63,128,0,0,9,17,40,72,0,0,0,1,178,7,0,2,255,15,0,32,83,8,84,8],p:[11,12,11,14,13,13,15,16],c:[{n:[],f:[]},{n:[147,,,,147,,,,147,,,,147,,,,147,,,,147,,,,147,,,,147],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[135,,,,,,,,,,,,,,,,135,,,,,,,,,,,,,,,,138,,,,,,,,,,,,,,,,140,,,,,,,,,,,,,,,,142,,,,,,,,,,,,,,,,144],f:[]},{n:[131,,,,,,,,133,,,,,,,,135,,,,,,,,,,,,,,,,135,,,,,,,,137,,,,,,,,139,,,,,,,,,,,,,,,,138,,,,,,,,140,,,,,,,,142],f:[]},{n:[142,,,,,,,,,,,,,,,,142,,,,,,,,,,,,,,,,145,,,,,,,,,,,,,,,,147,,,,,,,,,,,,,,,,149,,,,,,,,,,,,,,,,151],f:[]},{n:[131,,,,,,,,133,,,,,,,,138,,,,,,,,137,,,,,,,,135,,,,,,,,137,,,,,,,,142,,,,,,,,141,,,,,,,,138,,,,,,,,140,,,,,,,,145,,,,,,,,144],f:[]},{n:[138,,,,,,,,,,,,,,,,140,,,,,,,,,,,,,,,,142,,,,,,,,,,,,,,,,144,,,,,,,,,,,,,,,,145,,,,,,,,,,,,,,,,147],f:[]},{n:[142,,,,,,,,,,,,,,,,142,,,,,,,,,,,,,,,,147,,,,,,,,,,,,,,,,146,,,,,,,,,,,,,,,,149,,,,,,,,,,,,,,,,149],f:[]}]},{i:[1,0,128,0,1,0,128,9,0,37,13,5,20,0,0,0,0,0,0,0,2,255,0,0,32,47,3,0,1],p:[17,17,17,17,17,17,17,17],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[147,,147,147,147,,147,147,147,,147,147,147,,147,147,147,,147,147,147,,147,147,147,,147,147,147,,147,147],f:[]}]},{i:[0,99,116,79,0,53,116,0,83,0,4,6,69,52,0,0,0,0,0,0,2,14,0,0,32,0,0,0,0],p:[18,18,18,18,18,18,18,18],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[135,,,,135,,,,137,,,,135,,,,135,,,,135,,,,135,,,,135],f:[]}]},{i:[2,83,128,0,3,182,128,0,0,0,0,6,29,0,0,0,0,0,0,0,3,5,184,119,244,147,6,0,0],p:[19,20,19,21,22,22,23,24],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[111,,111,111,111,,111,111,111,,111,111,111,,111,,104,,104,104,104,,104,104,104,,104,104,104,,106],f:[]},{n:[107,,107,107,107,,107,107,109,,109,109,109,,109,109,111,,111,111,111,,111,111,111,,111,111,111,,111],f:[]},{n:[107,,107,107,107,,107,107,109,,109,109,109,,109,109,114,,114,114,114,,114,114,113,,113,113,113,114,115,116],f:[]},{n:[118,,118,118,118,,118,118,118,,118,118,118,,118,,111,,111,111,111,,111,111,111,,111,111,111,113,114,116],f:[]},{n:[114,,114,114,114,,114,114,114,,114,114,114,,114,114,116,,116,116,116,,116,116,116,,116,116,116,,116],f:[]},{n:[118,,118,118,118,,118,118,118,,118,118,118,,113,,118,,118,118,118,,118,118,118,,118,118,118,116,114,113],f:[]}]}],rowLen:4562,patternLen:32,endPattern:7,numChannels:5},l=function(){var t,s,e,i,h,a=function(t){return Math.sin(6.283184*t)},n=function(t){return.003959503758*2**((t-128)/12)},o=function(t,s,e){var i,h,a,o,l,c,p=r[t.i[0]],f=t.i[1],u=t.i[3]/32,d=r[t.i[4]],y=t.i[5],x=t.i[8]/32,m=t.i[9],w=t.i[10]*t.i[10]*4,g=t.i[11]*t.i[11]*4,b=t.i[12]*t.i[12]*4,k=1/b,v=-t.i[13]/16,S=t.i[14],E=e*2**(2-t.i[15]),T=new Int32Array(w+g+b),A=0,H=0;for(i=0,h=0;i<w+g+b;i++,h++)h>=0&&(h-=E,l=n(s+(15&(S=S>>8|(255&S)<<4))+t.i[2]-128),c=n(s+(15&S)+t.i[6]-128)*(1+8e-4*t.i[7])),a=1,i<w?a=i/w:i>=w+g&&(a=(1-(a=(i-w-g)*k))*3**(v*a)),o=p(A+=l*a**u)*f,o+=d(H+=c*a**x)*y,m&&(o+=(2*Math.random()-1)*m),T[i]=80*o*a|0;return T},r=[a,function(t){return t%1<.5?1:-1},function(t){return t%1*2-1},function(t){var s=t%1*4;return s<2?s-1:3-s}];this.init=function(a){t=a,s=a.endPattern,e=0,i=a.rowLen*a.patternLen*(s+1)*2,h=new Int32Array(i)},this.generate=function(){var n,l,c,p,f,u,d,y,x,m,w,g,b,k,v=new Int32Array(i),S=t.songData[e],E=t.rowLen,T=t.patternLen,A=0,H=0,P=!1,M=[];for(c=0;c<=s;++c)for(d=S.p[c],p=0;p<T;++p){var R=d?S.c[d-1].f[p]:0;R&&(S.i[R-1]=S.c[d-1].f[p+T]||0,R<17&&(M=[]));var D=r[S.i[16]],W=S.i[17]/512,z=2**(S.i[18]-9)/E,L=S.i[19],C=S.i[20],I=43.23529*S.i[21]*3.141592/44100,O=1-S.i[22]/255,j=1e-5*S.i[23],G=S.i[24]/32,N=S.i[25]/512,B=6.283184*2**(S.i[26]-9)/E,Y=S.i[27]/255,K=S.i[28]*E&-2;for(w=(c*T+p)*E,f=0;f<4;++f)if(u=d?S.c[d-1].n[p+f*T]:0){M[u]||(M[u]=o(S,u,E));var X=M[u];for(l=0,n=2*w;l<X.length;l++,n+=2)v[n]+=X[l]}for(l=0;l<E;l++)(m=v[y=2*(w+l)])||P?(g=I,L&&(g*=D(z*y)*W+.5),H+=(g=1.5*Math.sin(g))*(b=O*(m-H)-(A+=g*H)),m=3==C?H:1==C?b:A,j&&(m=(m*=j)<1?m>-1?a(.25*m):-1:1,m/=j),P=(m*=G)*m>1e-5,k=m*(1-(x=Math.sin(B*y)*N+.5)),m*=x):k=0,y>=K&&(k+=v[y-K+1]*Y,m+=v[y-K]*Y),v[y]=0|k,v[y+1]=0|m,h[y]+=0|k,h[y+1]+=0|m}return++e/t.numChannels},this.createAudioBuffer=function(t){for(var s=t.createBuffer(2,i/2,44100),e=0;e<2;e++)for(var a=s.getChannelData(e),n=e;n<i;n+=2)a[n>>1]=h[n]/65536;return s},this.createWave=function(){var t=44+2*i-8,s=t-36,e=new Uint8Array(44+2*i);e.set([82,73,70,70,255&t,t>>8&255,t>>16&255,t>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&s,s>>8&255,s>>16&255,s>>24&255]);for(var a=0,n=44;a<i;++a){var o=h[a];o=o<-32767?-32767:o>32767?32767:o,e[n++]=255&o,e[n++]=o>>8&255}return e},this.getData=function(t,s){for(var e=2*Math.floor(44100*t),i=new Array(s),a=0;a<2*s;a+=1){var n=e+a;i[a]=t>0&&n<h.length?h[n]/32768:0}return i}};function p(){var t=new l;t.init(o),setInterval(function(){if(!a&&(a=t.generate()>=1)){var s=t.createWave();(h=document.createElement("audio")).src=URL.createObjectURL(new Blob([s],{type:"audio/wav"})),n=!0}},0)}function f(t,s,e,i,h){this.x=t,this.y=s,this.remove=!1;let a=e-t,n=i-s,o=Math.sqrt(a*a+n*n);this.dx=a/o*h,this.dy=n/o*h,this.angle=Math.atan2(n,a),this.hb=new k(0,0,0,0),this.update=function(t){this.x+=this.dx,this.y+=this.dy,this.hb.x=this.x,this.hb.y=this.y,this.hb.w=-2,this.hb.h=8,T(this.hb,ht.hero.e.hb)&&(ht.shakeTime=.2,ht.hero.hit(3,this),this.remove=!0)},this.draw=function(t){t.save(),t.translate(ht.cam.x+this.x,ht.cam.y+this.y),t.rotate(this.angle),t.fillStyle="#7B3F00",t.fillRect(0,-1.5,16,3),t.fillStyle="silver",t.strokeStyle="#56675B",t.lineWidth=1,t.beginPath(),t.moveTo(20,0),t.lineTo(14,-4),t.lineTo(14,4),t.fill(),t.stroke(),t.restore()}}function u(t=0,s=0){this.x=t,this.y=s}function d(){var s=!0;this.cam=new u,this.ratio=1,this.tips=!0,this.time=0,this.ratio=G>800?G/800:N/600,this.scale=2,this.cube=16,this.scaled=this.scale*this.cube,this.hero=new j(16,16,0,0,0,y.HERO,this.scale),this.introT=0,this.shake=0,this.shakeTime=0,this.reset=!1,this.wait=2,this.genLevel=function(t){this.levels=[];for(let t=1;t<=10;t++){var s=new I(t,G,N,this.scale);s.reset(t,this.scaled),this.levels.push(s)}},this.setLevel=function(t){this.level=this.levels[t],this.hero.e.curLevel=t,this.hero.e.x=this.level.startPos[0],this.hero.e.y=this.level.startPos[1],this.level.objs.push(this.hero.e)},this.nextLevel=function(){this.setLevel(tt),tt++},this.genLevel(0),this.setLevel(0),this.menu=new t,this.update=function(t,e,h=!1){if(this.time+=t/1e3,s&&(s=!1,ctx.scale(this.ratio,this.ratio)),this.shake=it?Math.cos(U):0,ht.shakeTime>0&&(ht.shakeTime-=t/1e3),this.hero.setCurrentTile(this.scaled),h)this.level.draw(this.hero,t,h);else{for(this.level.draw(this.hero,t),this.hero.update(ctx,t),ct(ctx,.8,"black",0,0,G,75),this.level.tip&&(font="25px Papyrus",ct(ctx,.8,"black",0,N-100,G,100),ht.level.complete?ft(ctx,1,font,"WHITE",this.level.tip2,20,N-10):ft(ctx,1,font,"WHITE",this.level.tip,20,N-10)),font="30px Papyrus",ft(ctx,1,font,"WHITE","[M] Music: "+!nt,G-230,N-10),this.menu.ui.forEach(s=>s.update(t)),this.menu.tick(),i=1;i<=this.level.trees;i++)this.menu.tree.x=G-30*i,this.menu.tree.y=18,this.menu.tree.update(t);for(i=1;i<=this.level.rocks;i++)this.menu.rock.x=G-30*i,this.menu.rock.y=45,this.menu.rock.update(t)}this.level.mobs.forEach(s=>s.update(t)),this.cam.x=P(400-this.hero.e.x-20,this.cam.x,.8),this.cam.y=P(300-this.hero.e.y-80,this.cam.y,.8),this.level.objs=this.level.objs.filter(function(t){return t.hp>0}),this.level.dead=this.level.dead.filter(function(t){return t.e.alpha>=0}),this.level.mobs=this.level.mobs.filter(function(t){return t.e.hp>0})}}const y={AIR:0,GRASS:1,HERO:2,BRDE:3,WTR:4,SEA:5,SND:6,TREE:7,ROCK:8,CST:9,CNE:10,UI:11,HAM:12,SWD:13,AX:14,HP:15,HPE:16,HAND:17,SKELLY:18,GOB:19},x={FOLLOW:0,RANGED:1};function w(t,s,e,i,h,a,n,o,r,l){this.id=t,this.obj=null,this.up=b(o,r,colz,colz),i+=this.up,this.drop=g(o,r,colz,colz),this.e=new O(s,s,e,i,h,a,"",l,0,0),this.up>=0&&a==y.GRASS?(this.e.sx=16,this.e.sy=16):-12==this.up&&a==y.GRASS&&(this.e.sx=32,this.e.sy=16),this.column=o,this.row=r,this.active=!0,a==y.GRASS&&(this.e.y-=4),a==y.SND&&(this.e.y+=2),this.progress=!1,this.oscillationSpeed=.8,this.oscillationAmount=7,this.initialY=this.e.y,this.e.y=this.e.y+this.drop,this.update=function(t){if(this.e.y=P(this.e.y,this.initialY,.08),this.e.type==y.SEA){let t=.001*Date.now(),s=Math.sin(t*this.oscillationSpeed+this.column)*this.oscillationAmount;this.e.offsetY=0,this.e.y=this.initialY+s}this.e.update(t)}}function g(t,s,e,i){const h=e/2,a=i/2,n=Math.min(e,i)/3,o=(t-h)*(t-h)+(s-a)*(s-a);return-(500*Math.exp(-o/(2*n*n)))}function b(t,s,e,i){const h=e/2,a=i/2,n=Math.min(e,i)/4,o=Math.min(e,i)/3,r=2*(Math.random()-.5),l=t+r,c=s+r,p=Math.sqrt((l-h)*(l-h)+(c-a)*(c-a));return p<n?-24:p<o?-12:0}function k(t,s,e,i){this.x=t,this.y=s,this.w=e,this.h=i}function v(t,s){return Math.floor(Math.random()*(s-t+1)+t)}function S(t){return new k(t.x,t.y,t.w,t.h)}function E(t,s,e,i,h,a,n,o){return t<h+n&&t+e>h&&s<a+o&&s+i>a}function T(t,s){return t.x<s.x+s.w&&t.x+t.w>s.x&&t.y<s.y+s.h&&t.y+t.h>s.y}function A(t,s){this.x=t,this.y=s,this.set=function(t,s){this.x=t,this.y=s}}function H(t,s,e,i,h,a,n,o,r){t.save(),t.globalAlpha=r,t.translate(s,e),t.fillStyle=o,t.fillRect(i,h,a,n),t.restore()}function P(t,s,e){return(1-e)*t+e*s}function M(t,s){const e=Math.floor(t/2),i=Math.floor(s/2);return{x:16*(e-i)/2,y:16*(e+i)/2}}function R(t,s,e,i){let h=t/32,a=(s+2*e+i)/32*2,n=a-h,o=h+a;return r=Math.floor(n),c=Math.floor(o),D(r,c)}function D(t,s){return ht.level.tiles[s+ht.levels[ht.hero.e.curLevel].cols*t]}function W(t,s,e){const i=[-80,e.y-85],h=[85,e.y+50];return t>=i[0]&&t<=h[0]&&s>=i[1]&&s<=h[1]}function L(t,s,e){zzfx(...[,,102,,.03,.15,3,1.95,-1.5,,,,,1,,.1,,.55,.07,.28]);let i=25+e,h=s.x-t.e.x,a=s.y-t.e.y,n=Math.sqrt(h*h+a*a);0!==n&&(h/=n,a/=n),s.x+=h*i,s.y+=a*i}function C(t,s,e){let i=t.e.x>s.x?1:-1,h=t.e.y>s.y?1:-1;t.e.x+=i*e,t.e.y+=h*e}function I(t,s,e,i){this.tiles=[],this.objs=[],this.mobs=[],this.castle=[],this.active=!1,this.startPos=[-120,280],this.cols=colz,this.rocks=0,this.trees=0,this.mobs,this.complete=!1,this.bridge=!1,this.mobTime=0,this.cen=M(colz-1,colz-1),this.respawnDelay=10,this.maxMobs=10,this.dead=[],this.decor=[],this.maxTrees=t-1,this.maxRocks=t-2,this.allowGobs=!0,this.tip=null;let h=0;switch(t){case 1:this.tip="Use the Axe (3) to cut (space) down the trees.",this.tip2="Good job! Cross the bridge!!",this.maxMobs=2,this.respawnDelay=1,this.maxTrees=2,this.maxRocks=0,this.allowGobs=!0;break;case 2:this.tip="Use the Hammer (2) to break (Space) the rock.",this.tip2="Clearing resources stops a castle spawning mobs!",this.maxMobs=0,this.maxTrees=0,this.maxRocks=1,this.allowGobs=!1;break;case 3:this.tip="Attack with Sword (1) or fist (4) - (press / hold space)",this.tip2="Hold space to charging up attacks!",this.maxMobs=1,this.maxTrees=1,this.maxRocks=0,this.allowGobs=!1,this.respawnDelay=20,skelly=new Ft(16,16,this.cen.x,this.cen.y,0,y.SKELLY,x.FOLLOW,i,10),this.mobs.push(skelly),this.objs.push(skelly.e);break;case 4:this.tip="Looks like you are ready to battle!",this.tip2="Keep an eye out for upgrades after each level!",this.maxMobs=4,this.maxTrees=2,this.maxRocks=2}this.draw=function(t,s,e){if(this.tiles.forEach(t=>t.update(s,e)),e)this.castle.forEach(t=>t.update(s)),t.e.update(0),t.hands[0].x=30,t.hands[1].x=9,t.hands[0].y=29,t.hands[1].y=29;else{this.objs.sort((t,s)=>t.y-s.y),this.rocks=0,this.trees=0,this.decor.forEach(t=>{t.update(s),t.update(s,!0)}),this.objs.forEach(t=>{t.update(s),t.update(s,!0),t.type==y.ROCK&&t.hp>=0&&this.rocks++,t.type==y.TREE&&t.hp>=0&&this.trees++}),W(t.e.x,t.e.y,this.cen)?this.castle.forEach(t=>t.alpha=.3):this.castle.forEach(t=>t.alpha=1),this.castle.forEach(t=>t.update(s)),t.tool.type!=y.HAND&&t.tool.update(s),t.e.y>290&&W(t.e.x,t.e.y,this.cen)&&t.e.update(s),0==this.mobs.length&&0==this.rocks&&0==this.trees&&(this.complete=!0);for(let t=0;t<this.mobs.length;t++)this.mobs[t].update(s,this.mobs);if(this.complete&&!this.bridge){zzfx(...[1.02,,72,.02,.17,.26,,.01,,,100,.01,.14,,15,.1,,.7,.12,.24]),this.bridge=!0;let t=colz/2;for(r=0;r<3;r++)for(c=1;c<7;c++){let s=D(t+r,colz-c);s.e.type=y.BRDE,c<3&&(s.progress=!0),s.e.setType(),s.e.y=200,s.initialY-=5}}this.mobTime+=s/1e3,this.mobTime>this.respawnDelay&&(this.trees>0||this.rocks>0)&&this.mobs.length<this.maxMobs&&(this.mobTime=0,skelly=new Ft(16,16,this.cen.x,this.cen.y,0,y.SKELLY,x.FOLLOW,i,10),this.mobs.push(skelly),this.objs.push(skelly.e),this.allowGobs&&(gob=new Ft(18,15,this.cen.x,this.cen.y,0,y.GOB,x.RANGED,i,20),this.mobs.push(gob),this.objs.push(gob.e))),this.dead.forEach((t,e)=>{t.update(s),t.e.update(s)})}},this.reset=function(t,s){this.tiles=[],this.dead=[],h=0;let e=v(2,5),n=0,o=colz,l=0;for(r=0;r<o;r++)for(c=0;c<this.cols;c++){let t=1;r<4||c<4||c>colz-4||r>colz-4?t=y.SEA:(r<6||c<6||c>colz-6||r>colz-6)&&v(0,100)>50?t=y.SEA:(r<8||c<8||c>colz-8||r>colz-8)&&v(0,100)>20?t=y.SND:v(0,100)>99&&n<e&&(t=y.WTR,n++),xx=16*(c-r),yy=8*(c+r);var p=new w(l,16,xx,yy,0,t,!1,c,r,i);this.tiles.push(p),l++}const f=[];this.tiles.forEach((t,s)=>{t.e.type==y.WTR&&Array.from({length:v(3,8)},(t,s)=>s).forEach(s=>{Array.from({length:v(3,5)},(t,s)=>s).forEach(e=>{let i=(t.row+s)*colz+(t.column+e);i>=0&&i<this.tiles.length&&f.push(i)})})}),f.forEach(t=>{v(0,100)>20&&this.tiles[t].e.type!=y.WTR&&(this.tiles[t].e.type=y.WTR,this.tiles[t].e.setType(),this.tiles[t].initialY+=6)}),this.tiles.forEach(t=>{t.e.type==y.GRASS&&v(0,100)>98&&this.trees<this.maxTrees?W(t.e.x,t.e.y-t.drop-10-30,this.cen)||(obj=new O(16,23,t.e.x,t.e.y-t.drop-10-30,0,y.TREE,"",i,!1,3),obj.parent=t,t.obj=obj,this.objs.push(obj),this.trees++):t.e.type==y.GRASS&&v(0,100)>98&&this.rocks<this.maxRocks&&(W(t.e.x,t.e.y-t.drop-10,this.cen)||(obj=new O(16,16,t.e.x,t.e.y-t.drop-10,0,y.ROCK,"",i,!1,3),obj.parent=t,t.obj=obj,this.objs.push(obj),this.rocks++))});let u=this.cen.x,d=this.cen.y;a(this.castle,u+5,d-86,4,0,16,!0,y.CST,!0),a(this.castle,u-10,d-64,1,0,16),a(this.castle,u-26,d-56,1,0,16),a(this.castle,u-41,d-64,4,0,16,!0,y.CST,!0),a(this.castle,u+22,d-64,1,0,-16,!1),a(this.castle,u+38,d-56,1,0,-16,!1),a(this.castle,u+54,d-64,4,0,16,!0,y.CST,!0),a(this.castle,u+38,d-24,2,0,-16,!1),a(this.castle,u+22,d-18,2,0,-16,!1),a(this.castle,u-26,d-8,3,0,-16,!1),a(this.castle,u-10,d,3,0,-16,!1),a(this.castle,u+6,d-40,4,0,16,!0,y.CST,!0)};const a=(t,s,e,h,a=0,n=8,o=!0,r=y.CST,l=!1)=>{const c=o?t=>t>=0:t=>t<h,p=o?t=>--t:t=>++t;for(let l=o?h-1:0;c(l);l=p(l))t.push(new O(16,16,s+a*l,e+n*l,0,r,"",i,!1,0));l&&t.push(new O(16,16,s+a,e+n-20,0,y.CNE,"",i,!1,0))}}function O(t,e,i,h,a,n,o,r,l=!1,c=0,p=0){this.weapon=p,this.scale=r,this.type=n,this.width=t,this.height=e,this.mhWidth=t/-2,this.mhHeight=e/-2,this.mhWScld=t/-2*r,this.mhHScld=e/-2*r,this.hWidth=t/2,this.hHeight=e/2,this.cenX=i-this.mhWScld,this.cenY=h-this.mhHScld,this.angle=a,this.x=i,this.y=h,this.z=0,this.active=!0,this.colour=o,this.image=st,this.alpha=1,this.currentTile=0,this.isSolid=!1,this.isButton=l,this.time=0,this.maxHP=c,this.hp=this.maxHP,this.flip=!1,this.idle=0,this.offsetY=0,this.parent=null,this.wet=!1,this.ui=!1,this.hands=[],this.dead=!1,this.sx=0,this.sy=0,this.setHitbox=function(){this.hb=new k(0,0,0,0),this.sensor=new k(0,0,0,0),this.isButton&&(this.hb.w=2*this.width*this.scale,this.hb.h=2*this.height*this.scale)},this.setHitbox(),this.updateHitbox=function(){this.isButton?(this.hb.x=this.x-this.width,this.hb.y=this.y-this.height):(this.hb.x=this.x+this.scale/2,this.hb.y=this.y+this.scale/2,this.hb.w=this.width*this.scale-this.scale-10,this.hb.h=this.height*this.scale-this.scale,this.sensor.x=this.x-5,this.sensor.y=this.y-5,this.sensor.w=this.width*this.scale+10,this.sensor.h=this.height*this.scale+10)},this.update=function(i,h=!1){if(this.idle+=i/1e3,this.updateHitbox(),this.active){if(ctx.save(),ctx.translate(this.x,this.y-this.z),ctx.globalAlpha=this.alpha,img=this.image,s=this.scale,mhw=this.mhWidth,mhh=this.mhHeight,hw=this.hWidth,hh=this.hHeight,t=this.width,e=this.height,ht.shakeTime>0&&ctx.translate(ht.shake,ht.shake),this.ui)ctx.setTransform(1,0,0,1,0,0),this.flip&&(ctx.scale(-1,1),ctx.translate(-t*s,0)),ctx.drawImage(img,this.sx,this.sy,t,e,this.x,this.y,t*s,e*s);else if(ctx.translate(ht.cam.x,ht.cam.y),null==this.image)ctx.fillStyle=this.colour,ctx.fillRect(.5*mhw*s,.5*mhh*s,.5*t*s,.5*e*s);else{if(this.flip?(ctx.scale(-1,1),ctx.translate(-t*s-t,0)):ctx.scale(1,1),z=0,this.angle>0){let t=24;ctx.translate(t,t),ctx.rotate(this.angle*Math.PI/180),ctx.translate(-t,-t)}if(this.wet&&(e-=2),this.isHero()&&!h){if(ht.hero.hands.forEach(t=>{ctx.drawImage(img,t.sx,t.sy,t.width,t.height,t.x,t.y,t.width*t.scale,t.height*t.scale)}),ht.hero.dance&&(ctx.shadowColor="gold",ctx.shadowBlur=10),ht.hero.isGad&&(ctx.shadowColor="red",ctx.shadowBlur=20),ctx.drawImage(img,this.sx,this.sy,t,e,hw+z,hh,t*s,e*s),ht.hero.renderPower){ctx.globalAlpha=ht.hero.wepPower>2?ht.hero.wepPower/10:0;let i=ht.hero.wepPower<10,h=ht.hero.facing==At?t*s-10:t*s-20,a=10-e;ht.hero.facing!=At&&(ctx.scale(-1,1),ctx.translate(-t*s,0)),ctx.beginPath(),ctx.arc(h,a,20,Math.PI,2*Math.PI),ctx.lineWidth=i?10:15;let n=ctx.createLinearGradient(h-20,a,h+20,a);n.addColorStop(0,i?"#0a910f":"#fff"),n.addColorStop(ht.hero.wepPower/10,"#db6532");let o=ht.hero.wepPower/10+.01>1?1:ht.hero.wepPower/10+.01;n.addColorStop(o,i?"#06062e":"#db6532"),ctx.strokeStyle=n,ctx.stroke()}}else if(h){ctx.scale(1,-1),ctx.shadowColor="#000",ctx.shadowBlur=8,ctx.globalAlpha=this.isHero()&&this.wet?.3:.08;let i=this.isHero()?4:3.8;ctx.drawImage(et,this.sx,this.sy,t,e,hw+z,-i*e,t*s,e*s)}else(this.type==y.ROCK||this.type==y.TREE)&&tt<5&&(ctx.shadowColor="gold",ctx.shadowBlur=10),ctx.drawImage(img,this.sx,this.sy,t,e,hw+z,hh,t*s,e*s),this.type==y.SKELLY&&this.hands.forEach(t=>{ctx.drawImage(img,t.sx,t.sy,t.width,t.height,t.x,t.y,t.width*t.scale,t.height*t.scale)}),this.type!=y.SKELLY&&this.type!=y.GOB&&this.type!=y.ROCK&&this.type!=y.TREE||this.hp<this.maxHP&&1==this.alpha&&(ctx.globalAlpha=.7,ctx.fillRect(8,-15,26,10),ctx.fillStyle=this.type==y.ROCK?"#ededed":"#E15353",ctx.fillStyle=this.type==y.TREE?"green":ctx.fillStyle,ctx.fillRect(10,-13,22/this.maxHP*this.hp,6))}ctx.restore()}this.cenX=this.x-this.mhWScld,this.cenY=this.y-this.mhHScld},this.isHero=function(){return this.type==y.HERO},this.setType=function(){switch(this.alpha=1,this.sy=0,this.sx=0,this.isSolid=!1,this.type){case y.HERO:this.isSolid=!0,this.sx=0,this.sy=0;break;case y.GRASS:this.sx=16;break;case y.BRDE:this.sx=32;break;case y.WTR:case y.SEA:this.sx=48;break;case y.AIR:this.sx=144;break;case y.SND:this.sy=16;break;case y.TREE:this.isSolid=!0,this.sx=80;break;case y.ROCK:this.isSolid=!0,this.sx=64;break;case y.CST:this.isSolid=!0,this.sx=64,this.sy=16;break;case y.CNE:this.sx=48,this.sy=16;break;case y.UI:this.ui=!0,this.sy=32;break;case y.HAM:this.sx=16,this.sy=33,this.ui=!0;break;case y.SWD:this.sx=26,this.sy=33,this.ui=!0;break;case y.AX:this.sx=36,this.sy=32,this.ui=!0;break;case y.HP:this.sx=48,this.sy=32,this.ui=!0;break;case y.HPE:this.sx=64,this.sy=32,this.ui=!0;break;case y.HAND:this.sx=71,this.sy=42,this.ui=!0;break;case y.SKELLY:this.sx=96,this.sy=16;break;case y.GOB:this.sx=83,this.sy=33;break;case y.GRAVE:this.sx=85,this.sy=23}},this.setType()}function j(t,s,e,i,h,a,n){this.e=new O(t,s,e,i,h,a,"",n,!1,100),this.e.z=12,this.active=!0,this.particles=[];let o=null,r=null,l=0,c=At,p=0,f=0,u=0;this.time=0,this.deaths=0,this.moved=!1,this.tool=new O(10,10,e,i,0,y.HAND,"",n),this.tool.setType(),this.wepPower=0,this.attackTime=0,this.renderPower=!1,this.facing=c,this.attackOver=!1,this.dance=!1,this.axePower=1,this.hammerPower=1,this.castleDst=0,this.isGad=!1,this.gadDur=1e3,this.dmgTime=0;let d=0;this.punchProgress=0;let x=!1,m="idle";this.hState=m,this.hands=[],this.hands.push(new O(4,4,e,i,0,y.HAND,"",n,!1)),this.hands.push(new O(4,4,e,i,0,y.HAND,"",n,!1)),this.update=function(t,s){this.time+=s/1e3,this.moved=!1,this.active&&(this.curTile&&this.curTile.progress&&ht.nextLevel(),ut()||dt()||yt()||xt()?(p+=s,this.moved=!0):(l=0,p=0),yt()&&(this.e.y-=this.gMove(0,-1)),xt()&&(this.e.y+=this.gMove(0,1)),ut()&&(this.e.x-=this.gMove(-1,0),"punch"!=m&&"retracting"!=m&&(this.e.flip=!0,c=Tt)),dt()&&(this.e.x+=this.gMove(1,0),"punch"!=m&&"retracting"!=m&&(this.e.flip=!1,c=At)),gt()&&this.tool!=y.SWD&&this.setWeapon(y.SWD),bt()&&this.tool!=y.HAM&&this.setWeapon(y.HAM),kt()&&this.tool!=y.AX&&this.setWeapon(y.AX,!0),vt()&&this.tool!=y.HAND&&this.setWeapon(y.HAND));for(let e=0;e<=this.particles.length-1;e++)this.particles[e].update(t,s);this.punchDistance=75,this.punchSpeed=5;const e=this.e.wet?-6:0,i=this.moved?.01:.003,h=1.7*Math.sin(this.time*i),a=1.7*Math.sin(this.time*i+Math.PI);if(this.hands[0].x=30,this.hands[1].x=9,this.hands[0].y=this.moved?29+a+e:29+h+e,this.hands[1].y=29+h+e,this.e.idle>10||this.dance||this.moved){let t=.6*Math.sin(15*this.time);this.moved||(this.e.z+=t),this.hands[0].y-=6*t,this.hands[1].y+=6*t,this.e.idle>15&&(this.e.idle=0)}if(this.setWeaponX(s),this.setWeaponY(),!mt()||"idle"!=m&&"spin"!=m&&"swipe"!=m)switch(x&&(this.punchProgress+=this.punchSpeed,this.hands[1].x=this.punchProgress,this.hands[1].scale+=.1,this.tool.scale+=.1,m="punch",this.punchProgress>=this.punchDistance&&(m="retracting",x=!1,this.wepPower=0)),m){case"idle":this.wepPower=0,this.attackOver=!1;break;case"swipe":m="retracting"}else switch(m){case"idle":m=this.tool.type==y.HAND?"spin":"swipe";break;case"spin":d+=.8,this.hands[1].x+=4*Math.cos(d),this.hands[1].y+=4*Math.sin(d),d>=2*Math.PI&&(d=0,x=!0,this.punchProgress=0),this.chargeUp()}this.wepPower>=10?(ht.shakeTime=.1,this.dance=!0):this.dance=!1,f=this.e.x-this.e.mhWScld,u=this.e.y-this.e.mhHScld,this.hState=m,(this.attackTime>0||this.punchProgress>0)&&(c==At?(xtra=this.tool.type==y.HAND?25:0,hb=new k(this.e.x+16,this.e.y-10,33+xtra,35)):(xtra=this.tool.type==y.HAND?35:0,hb=new k(this.e.x-15-xtra,this.e.y-10,33+xtra,35)),ht.level.objs.forEach(t=>{if(t.type!=y.HERO&&!this.attackOver&&T(hb,t.hb))switch(t.type){case y.TREE:this.tool.type==y.AX&&(zzfx(...[2.15,,312,.02,.08,.13,4,.08,,1.7,,,.1,.9,,.1,.08,.7,,.25]),t.hp-=this.axePower,0==t.hp&&zzfx(...[2.03,,585,.05,.18,.35,2,3.08,,.4,,,.06,1.7,,.1,.42,.33,.14]),this.attackOver=!0),ht.shakeTime=.15;break;case y.ROCK:this.tool.type==y.HAM&&(t.hp-=this.hammerPower,zzfx(...[2.04,,265,,,.13,4,.74,,-9.2,,,.15,1.9,,.2,.16,.71,.08]),t.hp-=this.axePower,this.attackOver=!0),ht.shakeTime=.1;break;case y.SKELLY:t.parent.hit(s,this.tool.type,this.wepPower),ht.shakeTime=.2,this.attackOver=!0,t.parent.e.hp<=0&&ht.level.dead.push(t.parent),L(this,t.parent.e,this.wepPower);break;case y.GOB:t.parent.hit(s,this.tool.type,this.wepPower),zzfx(...[,,354,.01,.08,.13,2,.3,-1.5,.1,,.01,,1.7,,.4,,.75,.02,.22]),ht.shakeTime=.2,this.attackOver=!0,t.parent.e.hp<=0&&(ht.level.dead.push(t.parent),ht.level.decor.push(new O(7,9,t.parent.e.x,t.parent.e.y,0,y.GRAVE,"",n)))}})),this.renderPower=!("spin"!=m&&"swipe"!=m||this.tool.type!=y.HAND&&this.tool.type!=y.SWD),this.facing=c,this.isGad&&Date.now()-this.dmgTime>=this.gadDur&&(this.isGad=!1)},this.hit=function(t,s){this.isGad||(zzfx(...[.9,-.05,105,.04,.06,.03,3,1.1,-2.6,-1.1,,,,.4,,.4,,.7,.01,.21]),this.e.hp-=t,this.isGad=!0,this.dmgTime=Date.now(),C(this,s,5))},this.reset=function(){this.done=!1,this.particles=[];let t=ht.levels[this.e.curLevel];this.e.x=t.startPos[0],this.e.y=t.startPos[1]},this.kill=function(){this.active&&(ht.shakeTime=3)},this.setCurrentTile=function(t){this.moved&&(r=o,(o=R(this.e.x,this.e.y,this.e.height,this.e.z))&&r&&o.id!==r.id&&r.up!==o.up&&(this.e.z=.25*-o.up)),null!=o&&(o.e.type==y.WTR?(l=1,this.e.wet=!0):o.e.type==y.SEA?(l=.3,this.e.wet=!0):(l=3.2,this.e.wet=!1)),this.curTile=o},this.setWeaponX=function(t){switch(this.tool.type){case y.SWD:"idle"==m&&(this.tool.angle=c==At?80:45),"swipe"==m&&(this.chargeUp(),c==At?this.tool.angle>10&&(this.tool.angle-=3):this.tool.angle<90&&(this.tool.angle+=3)),"retracting"==m&&this.retract(),this.tool.x=this.e.x+this.hands[1].x+1;break;case y.HAM:"idle"==m&&(this.tool.angle=c==At?70:30),"swipe"==m&&(this.tool.angle=this.tool.angle=c==At?30:70,this.hands[0].y-=10,this.hands[1].y-=7),"retracting"==m&&this.retract(),this.tool.x=c==At?this.e.x+this.hands[1].x+1:this.e.x+this.hands[1].x-20,this.hands[1].x=30;break;case y.AX:"idle"==m&&(this.tool.angle=30),"swipe"==m&&(this.tool.angle=90,this.hands[0].y-=10,this.hands[1].y-=7),"retracting"==m&&this.retract(),this.tool.flip=c==At,this.hands[1].x=30,this.tool.x=c==At?this.e.x+this.hands[0].x+1:this.e.x+this.hands[0].x-40;break;case y.HAND:"retracting"==m&&(this.punchProgress-=this.punchSpeed,this.hands[1].x=this.punchProgress,this.hands[1].scale-=.1,this.tool.scale-=.1,this.punchProgress<=0&&(this.punchProgress=0,m="idle"))}},this.setWeaponY=function(){if("idle"==m||"swipe"==m){let t=c==At?0:1;this.tool.y=this.hands[t].y+this.e.y-this.e.z-17}},this.chargeUp=function(){this.wepPower=this.wepPower>=10?10:this.wepPower+=.25,this.wepPower},this.retract=function(){let t=c==At?1:0;this.tool.y=this.hands[t].y+this.e.y-this.e.z-17,this.tool.type==y.AX?this.tool.angle=330:this.tool.type==y.HAM?this.tool.angle=c==At?120:330:this.tool.type==y.SWD&&(this.tool.angle=c==At?P(this.tool.angle,120,.8):330),this.attackTime>.2?(m="idle",this.attackTime=0):this.attackTime+=Y/1e3},this.setWeapon=function(t,s=!1){"idle"==m&&(this.tool.type=t,this.tool.setType(),this.tool.flip=s,this.tool.ui=!1)},this.gMove=function(t,s,e=!1,i=!1){this.e.idle=0,rec=S(this.e.hb),rec.w=20,rec.h=10,rec.x+=t*l,rec.y+=s*l/2,canMove=!0;for(var h=0;h<ht.level.objs.length;h++)if(obj=ht.level.objs[h],null!=obj&&T(obj.hb,rec)&&2!=obj.type&&obj.isSolid){canMove=!1;break}return canMove?0!=s?l/2:l:0}}let G=window.innerWidth,N=window.innerHeight,B=!1,Y=0,K=Date.now(),X=Date.now(),U=0,F=0,q=new A(0,0),V=new A(0,0),J=new k(0,0,0,0),Q=!1,Z=!1,$=!1,_=!1,tt=1;colz=40+2*tt;let st=new Image;st.src="atlas.png",st.crossOrigin="anonymous";let et=new Image,it=!0,ht=new d;start=!1;let at=!0,nt=!1;function startGame(){ot.start()}p();let ot={canvas:document.createElement("canvas"),start:function(){this.canvas.width=G,this.canvas.height=N,this.context=this.canvas.getContext("2d"),this.context.scale(1,1),ctx=this.context,ctx.mozImageSmoothingEnabled=!1,ctx.webkitImageSmoothingEnabled=!1,ctx.imageSmoothingEnabled=!1,this.canvas.classList.add("screen"),document.body.insertBefore(this.canvas,document.body.childNodes[6]),this.frameNo=0,this.interval=setInterval(lt,20),et.crossOrigin="anonymous",et.src="atlas.png",et.onload=function(){et=rt(et)},window.addEventListener("keydown",function(t){start=!0,zzfxX=new AudioContext,t.preventDefault(),ot.keys=ot.keys||[],ot.keys[t.keyCode]="keydown"==t.type}),window.addEventListener("keyup",function(t){ot.keys[t.keyCode]="keydown"==t.type,t.keyCode==Yt&&($=!0),t.keyCode==zt&&(nt=!nt),t.keyCode==Kt&&(ht.tips=!ht.tips)}),window.addEventListener("mouseup",function(t){t.preventDefault(),Et(),Q=!0}),window.addEventListener("mousemove",function(t){t.preventDefault();var s=ot.canvas.getBoundingClientRect();q.set((t.clientX-s.left)/(s.right-s.left)*G,(t.clientY-s.top)/(s.bottom-s.top)*N)}),this.canvas.oncontextmenu=function(t){t.preventDefault()}},stop:function(){clearInterval(this.interval)},clear:function(){this.context.clearRect(0,0,4*this.canvas.width,4*this.canvas.height)}};function rt(t){const s=document.createElement("canvas");s.width=t.width,s.height=t.height;const e=s.getContext("2d");e.drawImage(t,0,0);const i=e.getImageData(0,0,s.width,s.height),h=i.data;for(let t=0;t<h.length;t+=4)0!==h[t+3]&&(h[t]=0,h[t+1]=0,h[t+2]=0);e.putImageData(i,0,0);const a=new Image;return a.src=s.toDataURL("image/png"),a}function lt(){if(Z&&(U=0,Z=!1,_=!1,tt=0,start=!1,B=!1,ht.genLevel(tt)),start&&(null!=ht.hero&&(ht.hero.e.active=!0),B=!0),K=X,X=Date.now(),U+=Y=X-K,B){ot.clear(),ht.update(Y,U,!1);let t="30px Papyrus";ft(ctx,1,t,"WHITE","Stage: "+(ht.hero.e.curLevel+1),270,40),ft(ctx,1,t,"WHITE","HP: "+ht.hero.e.hp,20,40),t="20px Papyrus",ft(ctx,1,t,"WHITE","Castle Resources:",G-260,20);ht.hero.e.curLevel;nt&&(h.pause(),at=!0),at&&a&&!nt&&(h.play(),h.loop=!0,at=!1)}else{ot.clear(),ctx=ot.context,ht.update(Y,U,!0),ctx.save(),ct(ctx,.8,"black",0,0,G,N);let t="70px Papyrus";ft(ctx,1,t,"WHITE","Fort Knight",30,90),t="50px Papyrus",ft(ctx,1,t,"WHITE","Press any key to start",30,N-120),t="30px Papyrus",ft(ctx,1,t,"RED","Controls",30,160),ft(ctx,1,t,"WHITE","WASD or Arrows to move",30,200),ft(ctx,1,t,"WHITE","Space to attack (Hold for charge)",30,250),ft(ctx,1,t,"WHITE","1,2,3,4 or click icons to change weapon",30,300),ft(ctx,1,t,"WHITE","A game by @CarelessLabs and @AdamTheWilliams for JS13k",30,N-50),ctx.restore()}Q=!1}function ct(t,s,e,i,h,a,n){t.save(),t.setTransform(1,0,0,1,0,0),t.globalAlpha=s,t.fillStyle=e,t.fillRect(i,h,a,n),t.restore()}function pt(t,s,e,i,h,a,n){var o=eval('"\\u'+h+'"');t.globalAlpha=s,t.font=e,t.fillStyle=i,t.fillText(o,a,n)}function ft(t,s,e,i,h,a,n){t.save(),t.setTransform(1,0,0,1,0,0),t.globalAlpha=s,t.font=e,t.fillStyle=i,t.fillText(h,a,n),t.restore()}function ut(){return ot.keys&&(ot.keys[Tt]||ot.keys[Rt])}function dt(){return ot.keys&&(ot.keys[At]||ot.keys[Wt])}function yt(){return ot.keys&&(ot.keys[Ht]||ot.keys[Mt])}function xt(){return ot.keys&&(ot.keys[Pt]||ot.keys[Dt])}function mt(){return ot.keys&&ot.keys[It]}function wt(){return ot.keys&&ot.keys[zt]}function gt(){return ot.keys&&ot.keys[jt]}function bt(){return ot.keys&&ot.keys[Gt]}function kt(){return ot.keys&&ot.keys[Nt]}function vt(){return ot.keys&&ot.keys[Bt]}function St(){return ot.keys&&ot.keys[Kt]}function Et(){V.set(q.x,q.y),J.x=q.x-5,J.y=q.y+5,J.h=10,J.w=10}var Tt=37,At=39,Ht=38,Pt=40,Mt=87,Rt=65,Dt=83,Wt=68,zt=77,Lt=0,Ct=2,It=32,Ot=69,jt=49,Gt=50,Nt=51,Bt=52,Yt=82,Kt=84,Xt=6,Ut=7;function Ft(t,s,i,h,a,n,o,r,l){this.e=new O(t,s,i,h,a,n,"",r,!1,l),this.e.parent=this,this.mtype=o,this.lastShotTime=0,this.spears=[],this.bspd=100,this.spd=.3,this.time=0,this.facing=At,this.e.hands.push(new O(4,4,i,h,0,y.HAND,"",r,!1)),this.e.hands.push(new O(4,4,i,h,0,y.HAND,"",r,!1)),this.shotDelay=1+v(0,5),this.dead=!1,this.hit=function(t,s,e){this.e.hp-=1+e},this.update=function(t){this.time+=t/1e3;let s=this.e.x,i=this.e.y;if(e=this.e,e.hp<=0)this.dead||(zzfx(...[2.02,,164,.01,.05,.01,,.96,-5.1,,,-.01,,,,.3,.12,.53,.04,.01]),this.dead=!0),e.x-=2*Math.cos(1e3*this.time*.008),e.y-=.7,e.alpha=e.alpha-.03>0?e.alpha-=.03:0;else{let h=1.7*Math.sin(500*this.time*.008);e.hands[0].y=25+h,e.hands[1].y=25-h,e.hands[0].x=25,e.hands[1].x=15;let a=this.steerFromNearbyMobs(ht.level.mobs,26);if(this.mtype==x.FOLLOW)e.y=i<ht.hero.e.y?i+=this.spd/2+a.y:i+=-this.spd/2+a.y,e.x=s<ht.hero.e.x?s+=this.spd+a.x:s+=-this.spd+a.x;else if(this.mtype==x.RANGED){if(Math.sqrt(Math.pow(this.e.x-ht.hero.e.x,2)+Math.pow(this.e.y-ht.hero.e.y,2))<120){let t=this.e.x-ht.hero.e.x,s=this.e.y-ht.hero.e.y,e=Math.sqrt(t*t+s*s);t/=e,s/=e,this.e.x+=t*this.spd*.8,this.e.y+=s*this.spd*.8}else e.y=i<ht.hero.e.y?i+=this.spd/4+a.y:i+=-this.spd/4+a.y,e.x=s<ht.hero.e.x?s+=this.spd/2+a.x:s+=-this.spd/2+a.x;if(this.time-this.lastShotTime>=this.shotDelay){let t=new f(this.e.x+20,this.e.y+20,ht.hero.e.x+16,ht.hero.e.y+16,2.5);this.spears.push(t),this.lastShotTime=this.time,v(0,100)>50?zzfx(...[1.02,,947,.04,.05,.14,2,.8,-1.1,-.4,-100,.04,-.01,,,,.01,.6,.02,.1]):zzfx(...[1.02,,947,.04,.06,.14,2,.8,-1.1,-.4,-100,.04,-.01,,,-.1,.01,.6,.02,.1])}}this.e.x>ht.hero.e.x?this.e.flip=!0:this.e.flip=!1;for(let s=0;s<this.spears.length;s++)this.spears[s].update(t),this.spears[s].draw(ctx)}},this.steerFromNearbyMobs=function(t,s){let e=0,i=0,h=0;for(let a=0;a<t.length;a++){let n=t[a],o=Math.sqrt(Math.pow(this.e.x-n.e.x,2)+Math.pow(this.e.y-n.e.y,2));n!==this&&o<s&&(e+=this.e.x-n.e.x,i+=this.e.y-n.e.y,h++)}h>0&&(e/=h,i/=h);let a=Math.sqrt(e*e+i*i);return a>0&&(e/=a,i/=a),{x:e,y:i}}}
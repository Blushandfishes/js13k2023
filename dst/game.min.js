function t(){for(this.ui=[],this.tree=new q(16,23,0,0,0,H.TREE,"",1.5),this.tree.ui=!0,this.rock=new q(16,16,0,0,0,H.ROCK,"",1.5),this.rock.ui=!0,ms=[[-75,H.HAM],[-161,H.SWD],[13,H.AX],[99,H.HAND]],i=0;i<ms.length;i++)this.ui.push(new q(16,16,Q/2+ms[i][0],V-88,0,H.UI,"",4,0,!0,ms[i][1])),this.ui.push(new q(10,10,Q/2+ms[i][0]+14,V-80,0,ms[i][1],"",4,!0));for(this.ui[7].sx=96,this.ui[7].sy=0,i=0;i<5;i++)this.ui.push(new q(16,16,20+32*i,0,0,H.HP,"",4,!0));this.ui.push(new q(6,16,212,0,0,H.HPE,"",4,!0)),m=new q(6,16,0,0,0,H.HPE,"",4,!0),m.flip=!0,this.ui.push(m),this.tick=function(){this.ui.forEach(t=>{t.type==H.UI&&at&&j(t.hb,nt)&&(at=!1,dt.hero.setWeapon(t.weapon))})}}var h,n=!1,a=!1,o={songData:[{i:[2,96,128,0,2,8,164,0,0,5,12,44,43,0,0,0,0,69,3,1,1,26,116,0,32,0,6,76,6],p:[1,3,1,4,5,6,7,8],c:[{n:[147,,,,,,,,150,,,,,,,,149,,,,,,150,149,147,,,,,,145],f:[]},{n:[],f:[]},{n:[147,,,,,,145,147,149,,,,,,147,145,147],f:[]},{n:[147,,,,,,145,147,149,,,,,,150,152,154,,,,,,,,153],f:[]},{n:[154,,,,,,,,157,,,,,,156,157,159,,,,,,,,154,,,,,,152],f:[]},{n:[154,,,,,,,,157,,,,,,156,157,159,,,,,,,,,,,,,,161],f:[]},{n:[162,,,,,,,,,,,,,,161,162,164,,,,,,,,,,,,,,161,164],f:[]},{n:[166,,,,,,,,,,,,,,,173,173],f:[]}]},{i:[3,61,128,0,3,63,128,0,0,9,17,40,72,0,0,0,1,178,7,0,2,255,15,0,32,83,8,84,8],p:[11,12,11,14,13,13,15,16],c:[{n:[],f:[]},{n:[147,,,,147,,,,147,,,,147,,,,147,,,,147,,,,147,,,,147],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[135,,,,,,,,,,,,,,,,135,,,,,,,,,,,,,,,,138,,,,,,,,,,,,,,,,140,,,,,,,,,,,,,,,,142,,,,,,,,,,,,,,,,144],f:[]},{n:[131,,,,,,,,133,,,,,,,,135,,,,,,,,,,,,,,,,135,,,,,,,,137,,,,,,,,139,,,,,,,,,,,,,,,,138,,,,,,,,140,,,,,,,,142],f:[]},{n:[142,,,,,,,,,,,,,,,,142,,,,,,,,,,,,,,,,145,,,,,,,,,,,,,,,,147,,,,,,,,,,,,,,,,149,,,,,,,,,,,,,,,,151],f:[]},{n:[131,,,,,,,,133,,,,,,,,138,,,,,,,,137,,,,,,,,135,,,,,,,,137,,,,,,,,142,,,,,,,,141,,,,,,,,138,,,,,,,,140,,,,,,,,145,,,,,,,,144],f:[]},{n:[138,,,,,,,,,,,,,,,,140,,,,,,,,,,,,,,,,142,,,,,,,,,,,,,,,,144,,,,,,,,,,,,,,,,145,,,,,,,,,,,,,,,,147],f:[]},{n:[142,,,,,,,,,,,,,,,,142,,,,,,,,,,,,,,,,147,,,,,,,,,,,,,,,,146,,,,,,,,,,,,,,,,149,,,,,,,,,,,,,,,,149],f:[]}]},{i:[1,0,128,0,1,0,128,9,0,37,13,5,20,0,0,0,0,0,0,0,2,255,0,0,32,47,3,0,1],p:[17,17,17,17,17,17,17,17],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[147,,147,147,147,,147,147,147,,147,147,147,,147,147,147,,147,147,147,,147,147,147,,147,147,147,,147,147],f:[]}]},{i:[0,99,116,79,0,53,116,0,83,0,4,6,69,52,0,0,0,0,0,0,2,14,0,0,32,0,0,0,0],p:[18,18,18,18,18,18,18,18],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[135,,,,135,,,,137,,,,135,,,,135,,,,135,,,,135,,,,135],f:[]}]},{i:[2,83,128,0,3,182,128,0,0,0,0,6,29,0,0,0,0,0,0,0,3,5,184,119,244,147,6,0,0],p:[19,20,19,21,22,22,23,24],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[111,,111,111,111,,111,111,111,,111,111,111,,111,,104,,104,104,104,,104,104,104,,104,104,104,,106],f:[]},{n:[107,,107,107,107,,107,107,109,,109,109,109,,109,109,111,,111,111,111,,111,111,111,,111,111,111,,111],f:[]},{n:[107,,107,107,107,,107,107,109,,109,109,109,,109,109,114,,114,114,114,,114,114,113,,113,113,113,114,115,116],f:[]},{n:[118,,118,118,118,,118,118,118,,118,118,118,,118,,111,,111,111,111,,111,111,111,,111,111,111,113,114,116],f:[]},{n:[114,,114,114,114,,114,114,114,,114,114,114,,114,114,116,,116,116,116,,116,116,116,,116,116,116,,116],f:[]},{n:[118,,118,118,118,,118,118,118,,118,118,118,,113,,118,,118,118,118,,118,118,118,,118,118,118,116,114,113],f:[]}]}],rowLen:4562,patternLen:32,endPattern:7,numChannels:5},l=function(){var t,e,s,i,h,n=function(t){return Math.sin(6.283184*t)},a=function(t){return.003959503758*2**((t-128)/12)},o=function(t,e,s){var i,h,n,o,c,l,u=r[t.i[0]],f=t.i[1],p=t.i[3]/32,d=r[t.i[4]],y=t.i[5],x=t.i[8]/32,w=t.i[9],m=t.i[10]*t.i[10]*4,g=t.i[11]*t.i[11]*4,b=t.i[12]*t.i[12]*4,v=1/b,k=-t.i[13]/16,S=t.i[14],M=s*2**(2-t.i[15]),E=new Int32Array(m+g+b),T=0,A=0;for(i=0,h=0;i<m+g+b;i++,h++)h>=0&&(h-=M,c=a(e+(15&(S=S>>8|(255&S)<<4))+t.i[2]-128),l=a(e+(15&S)+t.i[6]-128)*(1+8e-4*t.i[7])),n=1,i<m?n=i/m:i>=m+g&&(n=(1-(n=(i-m-g)*v))*3**(k*n)),o=u(T+=c*n**p)*f,o+=d(A+=l*n**x)*y,w&&(o+=(2*Math.random()-1)*w),E[i]=80*o*n|0;return E},r=[n,function(t){return t%1<.5?1:-1},function(t){return t%1*2-1},function(t){var e=t%1*4;return e<2?e-1:3-e}];this.init=function(n){t=n,e=n.endPattern,s=0,i=n.rowLen*n.patternLen*(e+1)*2,h=new Int32Array(i)},this.generate=function(){var a,c,l,u,f,p,d,y,x,w,m,g,b,v,k=new Int32Array(i),S=t.songData[s],M=t.rowLen,E=t.patternLen,T=0,A=0,H=!1,P=[];for(l=0;l<=e;++l)for(d=S.p[l],u=0;u<E;++u){var L=d?S.c[d-1].f[u]:0;L&&(S.i[L-1]=S.c[d-1].f[u+E]||0,L<17&&(P=[]));var R=r[S.i[16]],D=S.i[17]/512,W=2**(S.i[18]-9)/M,C=S.i[19],I=S.i[20],N=43.23529*S.i[21]*3.141592/44100,j=1-S.i[22]/255,z=1e-5*S.i[23],O=S.i[24]/32,B=S.i[25]/512,G=6.283184*2**(S.i[26]-9)/M,Y=S.i[27]/255,X=S.i[28]*M&-2;for(m=(l*E+u)*M,f=0;f<4;++f)if(p=d?S.c[d-1].n[u+f*E]:0){P[p]||(P[p]=o(S,p,M));var K=P[p];for(c=0,a=2*m;c<K.length;c++,a+=2)k[a]+=K[c]}for(c=0;c<M;c++)(w=k[y=2*(m+c)])||H?(g=N,C&&(g*=R(W*y)*D+.5),A+=(g=1.5*Math.sin(g))*(b=j*(w-A)-(T+=g*A)),w=3==I?A:1==I?b:T,z&&(w=(w*=z)<1?w>-1?n(.25*w):-1:1,w/=z),H=(w*=O)*w>1e-5,v=w*(1-(x=Math.sin(G*y)*B+.5)),w*=x):v=0,y>=X&&(v+=k[y-X+1]*Y,w+=k[y-X]*Y),k[y]=0|v,k[y+1]=0|w,h[y]+=0|v,h[y+1]+=0|w}return++s/t.numChannels},this.createAudioBuffer=function(t){for(var e=t.createBuffer(2,i/2,44100),s=0;s<2;s++)for(var n=e.getChannelData(s),a=s;a<i;a+=2)n[a>>1]=h[a]/65536;return e},this.createWave=function(){var t=44+2*i-8,e=t-36,s=new Uint8Array(44+2*i);s.set([82,73,70,70,255&t,t>>8&255,t>>16&255,t>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&e,e>>8&255,e>>16&255,e>>24&255]);for(var n=0,a=44;n<i;++n){var o=h[n];o=o<-32767?-32767:o>32767?32767:o,s[a++]=255&o,s[a++]=o>>8&255}return s},this.getData=function(t,e){for(var s=2*Math.floor(44100*t),i=new Array(e),n=0;n<2*e;n+=1){var a=s+n;i[n]=t>0&&a<h.length?h[a]/32768:0}return i}},u;function f(){var t=new l;t.init(o),setInterval(function(){if(!n&&(n=t.generate()>=1)){var e=t.createWave();(h=document.createElement("audio")).src=URL.createObjectURL(new Blob([e],{type:"audio/wav"})),a=!0}},0)}function p(t,e,s,i,h,n,a,o=Nt){}function d(t=0,e=0){this.x=t,this.y=e}var y=[];function x(t,e){for(m=u.createBuffer(1,96e3,48e3),gainNode=u.createGain(),b=m.getChannelData(0),i=96e3;i--;)b[i]=getSound(t,i);s=u.createBufferSource(),s.buffer=m,s.connect(gainNode),gainNode.connect(u.destination),gainNode.gain.value=e,s.start()}function w(t){if(Wt=((t,e)=>(e-t)/e),t>7e4)return null;Wt(t,7e4);return Math.sin(.001*t*Math.sin(.009*t)+Math.sin(t/100))}function g(t){if(t>1e4)return null;var e=(1e4-t)/1e4;return(128&Math.pow(t,1.055)?1:-1)*Math.pow(e,2)}function v(t){if(t>5e4)return null;var e=(5e4-t)/5e4;return(200&Math.pow(t,.9)?1:-1)*Math.pow(e,3)}function k(t){var e=1e4;if(t>e)return null;var s=(e-t)/e,i=Math.pow(s,2.1);return Math.pow(t,3)&(t<3333.3333333333335?16:99)?i:-i}function S(t){if(t>2e4)return null;var e=(2e4-t)/2e4;return Math.sin(.003*-t*Math.sin(.09*t+Math.sin(t/200))+Math.sin(t/100))*e*e}function M(t){if(t>1e4)return null;var e=(1e4-t)/1e4;return Math.sin(.01*t*Math.sin(.009*t+Math.sin(t/200))+Math.sin(t/100))*e*e}function E(t){if(t>2e3)return null;var e=(Wt=((t,e)=>(e-t)/e))(t,2e3);return 33&Math.pow(50*t,.7)?e:-e}function T(t){if(Wt=((t,e)=>(e-t)/e),t>2e4)return null;var e=Wt(t,2e4);return t*=.04,Math.sin(.03*-t*Math.sin(.09*t+Math.sin(t/200))+Math.sin(t/100))*e}function A(){var e=!0;this.cam=new d,this.ratio=1,this.tips=!0,this.time=0,this.ratio=Q>800?Q/800:V/600,this.scale=2,this.cube=16,this.scaled=this.scale*this.cube,this.hero=new J(16,16,0,0,0,H.HERO,this.scale),this.introT=0,this.shake=0,this.shakeTime=0,this.reset=!1,this.wait=2,this.genLevel=function(t){this.levels=[];for(let t=1;t<=10;t++){var e=new F(1,Q,V,this.scale);e.reset(t,this.scaled),this.levels.push(e)}},this.setLevel=function(t){console.log("Load Level: "+t),this.level=this.levels[t],this.hero.e.curLevel=t,this.hero.e.x=this.level.startPos[0],this.hero.e.y=this.level.startPos[1],this.level.objs.push(this.hero.e)},this.nextLevel=function(){this.setLevel(ut),ut++},this.genLevel(0),this.setLevel(0),this.menu=new t,this.update=function(t,s,h=!1){if(this.time+=t/1e3,e&&(e=!1,ctx.scale(this.ratio,this.ratio)),this.shake=pt?Math.cos(et):0,dt.shakeTime>0&&(dt.shakeTime-=t/1e3),this.hero.setCurrentTile(this.scaled),!h){for(this.level.draw(this.hero,t),this.hero.update(ctx,t),this.menu.ui.forEach(e=>e.update(t)),this.menu.tick(),i=0;i<this.level.trees;i++)this.menu.tree.x=8+30*i,this.menu.tree.y=150,this.menu.tree.update(t);for(i=0;i<this.level.rocks;i++)this.menu.rock.x=8+30*i,this.menu.rock.y=190,this.menu.rock.update(t)}this.level.mobs.forEach(e=>e.update(t)),this.cam.x=G(400-this.hero.e.x-20,this.cam.x,.8),this.cam.y=G(300-this.hero.e.y-80,this.cam.y,.8),this.level.objs=this.level.objs.filter(function(t){return t.hp>=0}),this.level.mobs=this.level.mobs.filter(function(t){return t.e.hp>=0})}}getSound=function(t,e){var s;switch(t){case te:s=w(e);break;case ee:s=k(e);break;case se:s=g(e);break;case ie:s=v(e);break;case he:s=S(e);break;case ne:s=M(e);break;case ae:s=E(e);break;case oe:s=T(e);break;default:return 1}return s};const H={AIR:0,GRASS:1,HERO:2,BRDE:3,WTR:4,SEA:5,SND:6,TREE:7,ROCK:8,CST:9,CNE:10,UI:11,HAM:12,SWD:13,AX:14,HP:15,HPE:16,HAND:17,SKELLY:18,GOB:19},P={FOLLOW:0,RANGED:1};function L(t,e,s,i,h,n,a,o,r,c){this.id=t,this.obj=null,this.up=D(o,r,colz,colz),i+=this.up,this.drop=R(o,r,colz,colz),this.e=new q(e,e,s,i,h,n,"",c,0,0),this.up>=0&&n==H.GRASS?(this.e.sx=16,this.e.sy=16):-12==this.up&&n==H.GRASS&&(this.e.sx=32,this.e.sy=16),this.column=o,this.row=r,this.active=!0,n==H.GRASS&&(this.e.y-=4),n==H.SND&&(this.e.y+=2),this.progress=!1,this.oscillationSpeed=.8,this.oscillationAmount=7,this.initialY=this.e.y,this.e.y=this.e.y+this.drop,this.update=function(t){if(this.e.y=G(this.e.y,this.initialY,.08),this.e.type==H.SEA){let t=.001*Date.now(),e=Math.sin(t*this.oscillationSpeed+this.column)*this.oscillationAmount;this.e.offsetY=0,this.e.y=this.initialY+e}this.e.update(t)}}function R(t,e,s,i){const h=s/2,n=i/2,a=Math.min(s,i)/3,o=(t-h)*(t-h)+(e-n)*(e-n);return-(500*Math.exp(-o/(2*a*a)))}function D(t,e,s,i){const h=s/2,n=i/2,a=Math.min(s,i)/4,o=Math.min(s,i)/3,r=2*(Math.random()-.5),c=t+r,l=e+r,u=Math.sqrt((c-h)*(c-h)+(l-n)*(l-n));return u<a?-24:u<o?-12:0}function W(t,e,s,i){this.x=t,this.y=e,this.w=s,this.h=i}function C(t,e){return Math.floor(Math.random()*(e-t+1)+t)}function I(t){return new W(t.x,t.y,t.w,t.h)}function N(t,e,s,i,h,n,a,o){return t<h+a&&t+s>h&&e<n+o&&e+i>n}function j(t,e){return t.x<e.x+e.w&&t.x+t.w>e.x&&t.y<e.y+e.h&&t.y+t.h>e.y}function O(t,e){this.x=t,this.y=e,this.set=function(t,e){this.x=t,this.y=e}}function B(t,e,s,i,h,n,a,o,r){t.save(),t.globalAlpha=r,t.translate(e,s),t.fillStyle=o,t.fillRect(i,h,n,a),t.restore()}function G(t,e,s){return(1-s)*t+s*e}function Y(t,e){const s=Math.floor(t/2),i=Math.floor(e/2);return{x:16*(s-i)/2,y:16*(s+i)/2}}function X(t,e,s,i){let h=t/32,n=(e+2*s+i)/32*2,a=n-h,o=h+n;return r=Math.floor(a),c=Math.floor(o),K(r,c)}function K(t,e){return dt.level.tiles[e+dt.levels[dt.hero.e.curLevel].cols*t]}function U(t,e,s){const i=[-90,s.y-80],h=[90,s.y+20];return t>=i[0]&&t<=h[0]&&e>=i[1]&&e<=h[1]}function F(t,e,s,i){this.tiles=[],this.objs=[],this.mobs=[],this.castle=[],this.active=!1,this.startPos=[-120,280],this.cols=colz,this.rocks=0,this.trees=0,this.complete=!1,this.bridge=!1,this.mobTime=0,this.cen=Y(colz-1,colz-1),this.respawnDelay=8,this.maxMobs=20;let h=0;this.draw=function(t,e,s){this.tiles.forEach(t=>t.update(e,s)),this.objs.sort((t,e)=>t.y-e.y),this.rocks=0,this.trees=0,this.objs.forEach(t=>{t.update(e),t.update(e,!0),t.type==H.ROCK&&this.rocks++,t.type==H.TREE&&this.trees++}),U(t.e.x,t.e.y,this.cen)?this.castle.forEach(t=>t.alpha=.3):this.castle.forEach(t=>t.alpha=1),this.castle.forEach(t=>t.update(e)),t.tool.type!=H.HAND&&t.tool.update(e),t.e.y>290&&U(t.e.x,t.e.y,this.cen)&&t.e.update(e),0==this.mobs.length&&0==this.rocks&&0==this.trees&&(this.complete=!0);for(let t=0;t<this.mobs.length;t++)this.mobs[t].update(e,this.mobs);if(this.complete&&!this.bridge){this.bridge=!0;let t=colz/2;for(r=0;r<3;r++)for(c=1;c<7;c++){let e=K(t+r,colz-c);e.e.type=H.BRDE,c<3&&(e.progress=!0),e.e.setType(),e.e.y=200,e.initialY-=5}}this.mobTime+=e/1e3,this.mobTime>this.respawnDelay&&(this.trees>0||this.rocks>0)&&this.mobs.length<this.maxMobs&&(this.mobTime=0,skelly=new re(16,16,this.cen.x,this.cen.y,0,H.SKELLY,P.FOLLOW,i,10),this.mobs.push(skelly),this.objs.push(skelly.e),gob=new re(18,15,this.cen.x,this.cen.y,0,H.GOB,P.RANGED,i,20),this.mobs.push(gob),this.objs.push(gob.e))},this.reset=function(t,e){console.log("Generate Level: "+t),this.tiles=[],this.dTiles=[],h=0;let s=C(2,5),a=0,o=colz,l=0;for(r=0;r<o;r++)for(c=0;c<this.cols;c++){let t=1;r<4||c<4||c>colz-4||r>colz-4?t=H.SEA:(r<6||c<6||c>colz-6||r>colz-6)&&C(0,100)>50?t=H.SEA:(r<8||c<8||c>colz-8||r>colz-8)&&C(0,100)>20?t=H.SND:C(0,100)>99&&a<s&&(t=H.WTR,a++),xx=16*(c-r),yy=8*(c+r);var u=new L(l,16,xx,yy,0,t,!1,c,r,i);this.tiles.push(u),l++}const f=[];this.tiles.forEach((t,e)=>{t.e.type==H.WTR&&Array.from({length:C(3,8)},(t,e)=>e).forEach(e=>{Array.from({length:C(3,5)},(t,e)=>e).forEach(s=>{let i=(t.row+e)*colz+(t.column+s);i>=0&&i<this.tiles.length&&f.push(i)})})}),f.forEach(t=>{C(0,100)>20&&this.tiles[t].e.type!=H.WTR&&(this.tiles[t].e.type=H.WTR,this.tiles[t].e.setType(),this.tiles[t].initialY+=6)}),maxTrees=2+t,maxRocks=1+t,this.tiles.forEach(t=>{t.e.type==H.GRASS&&C(0,100)>98&&this.trees<maxTrees?U(t.e.x,t.e.y-t.drop-10-30,this.cen)||(obj=new q(16,23,t.e.x,t.e.y-t.drop-10-30,0,H.TREE,"",i,!1,2),obj.parent=t,t.obj=obj,this.objs.push(obj),this.trees++):t.e.type==H.GRASS&&C(0,100)>98&&this.rocks<maxRocks&&(U(t.e.x,t.e.y-t.drop-10,this.cen)||(obj=new q(16,16,t.e.x,t.e.y-t.drop-10,0,H.ROCK,"",i,!1,4),obj.parent=t,t.obj=obj,this.objs.push(obj),this.rocks++))}),skelly=new re(16,16,this.cen.x,this.cen.y,0,H.SKELLY,P.FOLLOW,i,10),this.mobs.push(skelly),this.objs.push(skelly.e);let p=this.cen.x,d=this.cen.y;n(this.castle,p+5,d-86,4,0,16,!0,H.CST,!0),n(this.castle,p-10,d-64,1,0,16),n(this.castle,p-26,d-56,1,0,16),n(this.castle,p-41,d-64,4,0,16,!0,H.CST,!0),n(this.castle,p+22,d-64,1,0,-16,!1),n(this.castle,p+38,d-56,1,0,-16,!1),n(this.castle,p+54,d-64,4,0,16,!0,H.CST,!0),n(this.castle,p+38,d-24,2,0,-16,!1),n(this.castle,p+22,d-18,2,0,-16,!1),n(this.castle,p-26,d-8,3,0,-16,!1),n(this.castle,p-10,d,3,0,-16,!1),n(this.castle,p+6,d-40,4,0,16,!0,H.CST,!0)};const n=(t,e,s,h,n=0,a=8,o=!0,r=H.CST,c=!1)=>{const l=o?t=>t>=0:t=>t<h,u=o?t=>--t:t=>++t;for(let c=o?h-1:0;l(c);c=u(c))t.push(new q(16,16,e+n*c,s+a*c,0,r,"",i,!1,0));c&&t.push(new q(16,16,e+n,s+a-20,0,H.CNE,"",i,!1,0))}}function q(t,e,i,h,n,a,o,r,c=!1,l=0,u=0){this.weapon=u,this.scale=r,this.type=a,this.width=t,this.height=e,this.mhWidth=t/-2,this.mhHeight=e/-2,this.mhWScld=t/-2*r,this.mhHScld=e/-2*r,this.hWidth=t/2,this.hHeight=e/2,this.cenX=i-this.mhWScld,this.cenY=h-this.mhHScld,this.angle=n,this.x=i,this.y=h,this.z=0,this.active=!0,this.colour=o,this.image=ft,this.alpha=1,this.currentTile=0,this.isSolid=!1,this.isButton=c,this.time=0,this.maxHP=l,this.hp=this.maxHP,this.flip=!1,this.idle=0,this.offsetY=0,this.parent=null,this.wet=!1,this.ui=!1,this.hands=[],this.sx=0,this.sy=0,this.setHitbox=function(){this.hb=new W(0,0,0,0),this.sensor=new W(0,0,0,0),this.isButton&&(this.hb.w=2*this.width*this.scale,this.hb.h=2*this.height*this.scale)},this.setHitbox(),this.updateHitbox=function(){this.isButton?(this.hb.x=this.x-this.width,this.hb.y=this.y-this.height):(this.hb.x=this.x+this.scale/2,this.hb.y=this.y+this.scale/2,this.hb.w=this.width*this.scale-this.scale-10,this.hb.h=this.height*this.scale-this.scale,this.sensor.x=this.x-5,this.sensor.y=this.y-5,this.sensor.w=this.width*this.scale+10,this.sensor.h=this.height*this.scale+10)},this.update=function(i,h=!1){if(this.idle+=i/1e3,this.updateHitbox(),this.active){if(ctx.save(),ctx.translate(this.x,this.y-this.z),ctx.globalAlpha=this.alpha,img=this.image,s=this.scale,mhw=this.mhWidth,mhh=this.mhHeight,hw=this.hWidth,hh=this.hHeight,t=this.width,e=this.height,dt.shakeTime>0&&ctx.translate(dt.shake,dt.shake),this.ui)ctx.setTransform(1,0,0,1,0,0),this.flip&&(ctx.scale(-1,1),ctx.translate(-t*s,0)),ctx.drawImage(img,this.sx,this.sy,t,e,this.x,this.y,t*s,e*s);else if(ctx.translate(dt.cam.x,dt.cam.y),null==this.image)ctx.fillStyle=this.colour,ctx.fillRect(.5*mhw*s,.5*mhh*s,.5*t*s,.5*e*s);else{if(this.flip?(ctx.scale(-1,1),ctx.translate(-t*s-t,0)):ctx.scale(1,1),z=0,this.angle>0){let t=24;ctx.translate(t,t),ctx.rotate(this.angle*Math.PI/180),ctx.translate(-t,-t)}if(this.wet&&(e-=2),this.isHero()&&!h){if(dt.hero.hands.forEach(t=>{ctx.drawImage(img,t.sx,t.sy,t.width,t.height,t.x,t.y,t.width*t.scale,t.height*t.scale)}),dt.hero.dance&&(ctx.shadowColor="gold",ctx.shadowBlur=10),ctx.drawImage(img,this.sx,this.sy,t,e,hw+z,hh,t*s,e*s),dt.hero.renderPower){ctx.globalAlpha=dt.hero.wepPower>2?dt.hero.wepPower/10:0;let i=dt.hero.wepPower<10,h=dt.hero.facing==Nt?t*s-10:t*s-20,n=10-e;dt.hero.facing!=Nt&&(ctx.scale(-1,1),ctx.translate(-t*s,0)),ctx.beginPath(),ctx.arc(h,n,20,Math.PI,2*Math.PI),ctx.lineWidth=i?10:15;let a=ctx.createLinearGradient(h-20,n,h+20,n);a.addColorStop(0,i?"#0a910f":"#fff"),a.addColorStop(dt.hero.wepPower/10,"#db6532");let o=dt.hero.wepPower/10+.01>1?1:dt.hero.wepPower/10+.01;a.addColorStop(o,i?"#06062e":"#db6532"),ctx.strokeStyle=a,ctx.stroke()}}else if(h){ctx.scale(1,-1),ctx.shadowColor="#000",ctx.shadowBlur=8,ctx.globalAlpha=this.isHero()&&this.wet?.3:.08;let i=this.isHero()?4:3.8;ctx.drawImage(img,this.sx,this.sy,t,e,hw+z,-i*e,t*s,e*s)}else ctx.drawImage(img,this.sx,this.sy,t,e,hw+z,hh,t*s,e*s),this.type==H.SKELLY&&this.hands.forEach(t=>{ctx.drawImage(img,t.sx,t.sy,t.width,t.height,t.x,t.y,t.width*t.scale,t.height*t.scale)})}ctx.restore()}this.cenX=this.x-this.mhWScld,this.cenY=this.y-this.mhHScld},this.isHero=function(){return this.type==H.HERO},this.setType=function(){switch(this.alpha=1,this.sy=0,this.sx=0,this.isSolid=!1,this.type){case H.HERO:this.isSolid=!0,this.sx=0,this.sy=0;break;case H.GRASS:this.sx=16;break;case H.BRDE:this.sx=32;break;case H.WTR:case H.SEA:this.sx=48;break;case H.AIR:this.sx=144;break;case H.SND:this.sy=16;break;case H.TREE:this.isSolid=!0,this.sx=80;break;case H.ROCK:this.isSolid=!0,this.sx=64;break;case H.CST:this.isSolid=!0,this.sx=64,this.sy=16;break;case H.CNE:this.sx=48,this.sy=16;break;case H.UI:this.ui=!0,this.sy=32;break;case H.HAM:this.sx=16,this.sy=33,this.ui=!0;break;case H.SWD:this.sx=26,this.sy=33,this.ui=!0;break;case H.AX:this.sx=36,this.sy=32,this.ui=!0;break;case H.HP:this.sx=48,this.sy=32,this.ui=!0;break;case H.HPE:this.sx=64,this.sy=32,this.ui=!0;break;case H.HAND:this.sx=71,this.sy=42,this.ui=!0;break;case H.SKELLY:this.sx=96,this.sy=16;break;case H.GOB:this.sx=83,this.sy=33}},this.setType()}function J(t,e,s,i,h,n,a){this.e=new q(t,e,s,i,h,n,"",a,!1,100),this.e.z=24,this.active=!0,this.hp=2,this.particles=[];let o=null,r=null,c=0,l=Nt,u=0,f=0,p=0;this.time=0,this.deaths=0,this.moved=!1,this.tool=new q(10,10,s,i,0,H.HAND,"",a),this.tool.setType(),this.wepPower=0,this.attackTime=0,this.renderPower=!1,this.facing=l,this.attackOver=!1,this.dance=!1,this.axePower=1,this.hammerPower=1,this.castleDst=0;let d=0;this.punchProgress=0;let y=!1,x="idle";this.hState=x,this.hands=[],this.hands.push(new q(4,4,s,i,0,H.HAND,"",a,!1)),this.hands.push(new q(4,4,s,i,0,H.HAND,"",a,!1)),this.update=function(t,e){this.time+=e/1e3,this.moved=!1,this.active&&(this.curTile&&this.curTile.progress&&dt.nextLevel(),St()||Mt()||Et()||Tt()?(u+=e,this.moved=!0):(c=0,u=0),Et()&&(this.e.y-=this.gMove(0,-1)),Tt()&&(this.e.y+=this.gMove(0,1)),St()&&(this.e.x-=this.gMove(-1,0),"punch"!=x&&"retracting"!=x&&(this.e.flip=!0,l=It)),Mt()&&(this.e.x+=this.gMove(1,0),"punch"!=x&&"retracting"!=x&&(this.e.flip=!1,l=Nt)),Pt()&&this.tool!=H.SWD&&this.setWeapon(H.SWD),Lt()&&this.tool!=H.HAM&&this.setWeapon(H.HAM),Rt()&&this.tool!=H.AX&&this.setWeapon(H.AX,!0),Dt()&&this.tool!=H.HAND&&this.setWeapon(H.HAND));for(let s=0;s<=this.particles.length-1;s++)this.particles[s].update(t,e);this.punchDistance=75,this.punchSpeed=5;const s=this.e.wet?-6:0,i=this.moved?.01:.003,h=1.7*Math.sin(this.time*i),n=1.7*Math.sin(this.time*i+Math.PI);if(this.hands[0].x=30,this.hands[1].x=9,this.hands[0].y=this.moved?29+n+s:29+h+s,this.hands[1].y=29+h+s,this.e.idle>10||this.dance||this.moved){let t=.6*Math.sin(15*this.time);this.moved||(this.e.z+=t),this.hands[0].y-=6*t,this.hands[1].y+=6*t,this.e.idle>15&&(this.e.idle=0)}if(this.setWeaponX(e),this.setWeaponY(),!At()||"idle"!=x&&"spin"!=x&&"swipe"!=x)switch(y&&(this.punchProgress+=this.punchSpeed,this.hands[1].x=this.punchProgress,this.hands[1].scale+=.1,this.tool.scale+=.1,x="punch",this.punchProgress>=this.punchDistance&&(x="retracting",y=!1,this.wepPower=0)),x){case"idle":this.wepPower=0,this.attackOver=!1;break;case"swipe":x="retracting"}else switch(x){case"idle":x=this.tool.type==H.HAND?"spin":"swipe";break;case"spin":d+=.8,this.hands[1].x+=4*Math.cos(d),this.hands[1].y+=4*Math.sin(d),d>=2*Math.PI&&(d=0,y=!0,this.punchProgress=0),this.chargeUp()}if(this.wepPower>=10?(dt.shakeTime=.1,this.dance=!0):this.dance=!1,f=this.e.x-this.e.mhWScld,p=this.e.y-this.e.mhHScld,this.hState=x,this.attackTime>0||this.punchProgress>0){let t=l==Nt?20:-20;hb=new W(this.e.x+t,this.e.y,this.e.width,this.e.height),dt.level.objs.forEach(t=>{if(t.type!=H.HERO&&!this.attackOver&&j(hb,t.hb))switch(t.type){case H.TREE:this.tool.type==H.AX&&(t.hp-=this.axePower,this.attackOver=!0),dt.shakeTime=.15;break;case H.ROCK:this.tool.type==H.HAM&&(t.hp-=this.hammerPower,this.attackOver=!0),dt.shakeTime=.1;break;case H.SKELLY:case H.GOB:t.parent.hit(e,this.tool.type,this.wepPower),dt.shakeTime=.1}})}this.renderPower=!("spin"!=x&&"swipe"!=x||this.tool.type!=H.HAND&&this.tool.type!=H.SWD),this.facing=l},this.reset=function(){this.done=!1,this.particles=[],this.hp=2;let t=dt.levels[this.e.curLevel];this.e.x=t.startPos[0],this.e.y=t.startPos[1]},this.kill=function(){this.active},this.setCurrentTile=function(t){this.moved&&(r=o,(o=X(this.e.x,this.e.y,this.e.height,this.e.z))&&r&&o.id!==r.id&&r.up!==o.up&&(this.e.z=.25*-o.up)),null!=o&&(o.e.type==H.WTR?(c=1,this.e.wet=!0):o.e.type==H.SEA?(c=.3,this.e.wet=!0):(c=3.2,this.e.wet=!1)),this.curTile=o},this.setWeaponX=function(t){switch(this.tool.type){case H.SWD:"idle"==x&&(this.tool.angle=l==Nt?80:45),"swipe"==x&&(this.chargeUp(),l==Nt?this.tool.angle>10&&(this.tool.angle-=3):this.tool.angle<90&&(this.tool.angle+=3)),"retracting"==x&&this.retract(),this.tool.x=this.e.x+this.hands[1].x+1;break;case H.HAM:"idle"==x&&(this.tool.angle=l==Nt?70:30),"swipe"==x&&(this.tool.angle=this.tool.angle=l==Nt?30:70,this.hands[0].y-=10,this.hands[1].y-=7),"retracting"==x&&this.retract(),this.tool.x=l==Nt?this.e.x+this.hands[1].x+1:this.e.x+this.hands[1].x-20,this.hands[1].x=30;break;case H.AX:"idle"==x&&(this.tool.angle=30),"swipe"==x&&(this.tool.angle=90,this.hands[0].y-=10,this.hands[1].y-=7),"retracting"==x&&this.retract(),this.tool.flip=l==Nt,this.hands[1].x=30,this.tool.x=l==Nt?this.e.x+this.hands[0].x+1:this.e.x+this.hands[0].x-40;break;case H.HAND:"retracting"==x&&(this.punchProgress-=this.punchSpeed,this.hands[1].x=this.punchProgress,this.hands[1].scale-=.1,this.tool.scale-=.1,this.punchProgress<=0&&(this.punchProgress=0,x="idle"))}},this.setWeaponY=function(){if("idle"==x||"swipe"==x){let t=l==Nt?0:1;this.tool.y=this.hands[t].y+this.e.y-this.e.z-17}},this.chargeUp=function(){this.wepPower=this.wepPower>=10?10:this.wepPower+=.25,this.wepPower},this.retract=function(){let t=l==Nt?1:0;this.tool.y=this.hands[t].y+this.e.y-this.e.z-17,this.tool.type==H.AX?this.tool.angle=330:this.tool.type==H.HAM?this.tool.angle=l==Nt?120:330:this.tool.type==H.SWD&&(this.tool.angle=l==Nt?G(this.tool.angle,120,.8):330),this.attackTime>.2?(x="idle",this.attackTime=0):this.attackTime+=$/1e3},this.setWeapon=function(t,e=!1){"idle"==x&&(this.tool.type=t,this.tool.setType(),this.tool.flip=e,this.tool.ui=!1)},this.gMove=function(t,e,s=!1,i=!1){this.e.idle=0,rec=I(this.e.hb),rec.w=20,rec.h=10,rec.x+=t*c,rec.y+=e*c/2,canMove=!0;for(var h=0;h<dt.level.objs.length;h++)if(obj=dt.level.objs[h],null!=obj&&j(obj.hb,rec)&&2!=obj.type&&obj.isSolid){canMove=!1;break}return canMove?0!=e?c/2:c:0}}let Q=window.innerWidth,V=window.innerHeight,Z=!1,$=0,_=Date.now(),tt=Date.now(),et=0,st=0,it=new O(0,0),ht=new O(0,0),nt=new W(0,0,0,0),at=!1,ot=!1,rt=!1,ct="990099",lt=!1,ut=1;colz=40+2*ut;let ft=new Image;ft.src="atlas.png";let pt=!0,dt=new A,yt=!1,xt=!0,wt=!1;function startGame(){mt.start()}f();let mt={canvas:document.createElement("canvas"),start:function(){this.canvas.width=Q,this.canvas.height=V,this.context=this.canvas.getContext("2d"),this.context.scale(1,1),ctx=this.context,ctx.mozImageSmoothingEnabled=!1,ctx.webkitImageSmoothingEnabled=!1,ctx.imageSmoothingEnabled=!1,this.canvas.classList.add("screen"),document.body.insertBefore(this.canvas,document.body.childNodes[6]),this.frameNo=0,this.interval=setInterval(gt,20),window.addEventListener("keydown",function(t){yt=!0,t.preventDefault(),mt.keys=mt.keys||[],mt.keys[t.keyCode]="keydown"==t.type}),window.addEventListener("keyup",function(t){mt.keys[t.keyCode]="keydown"==t.type,t.keyCode==$t&&(rt=!0),t.keyCode==Xt&&(wt=!wt),t.keyCode==_t&&(dt.tips=!dt.tips)}),window.addEventListener("mouseup",function(t){t.preventDefault(),Ct(),at=!0}),window.addEventListener("mousemove",function(t){t.preventDefault();var e=mt.canvas.getBoundingClientRect();it.set((t.clientX-e.left)/(e.right-e.left)*Q,(t.clientY-e.top)/(e.bottom-e.top)*V)}),this.canvas.oncontextmenu=function(t){t.preventDefault()}},stop:function(){clearInterval(this.interval)},clear:function(){this.context.clearRect(0,0,4*this.canvas.width,4*this.canvas.height)}};function gt(){if(ot&&(et=0,ot=!1,lt=!1,ut=0,yt=!1,Z=!1,dt.genLevel(ut)),yt&&(null!=dt.hero&&(dt.hero.e.active=!0),Z=!0,null==u&&(u=new AudioContext)),_=tt,tt=Date.now(),et+=$=tt-_,Z){mt.clear(),dt.update($,et,!1);let t="30px Papyrus";kt(ctx,1,t,"WHITE","[M] Music: "+!wt,Q-230,30),kt(ctx,1,t,"WHITE","[R] Reset Level",Q-230,70),kt(ctx,1,t,"WHITE","Level: "+(dt.hero.e.curLevel+1),10,100),kt(ctx,1,t,"WHITE","Castle Resources:",10,140),dt.hero.curTile&&kt(ctx,1,t,"WHITE","Row: "+dt.hero.curTile.row+" Col: "+dt.hero.curTile.column,10,400),kt(ctx,1,t,"WHITE","STAGE: "+ut,10,450);dt.hero.e.curLevel;wt&&(h.pause(),xt=!0),xt&&n&&!wt&&(h.play(),h.loop=!0,xt=!1)}else{mt.clear(),ctx=mt.context,dt.update($,et,!0),ctx.save(),bt(ctx,.1,"#"+ct,0,0,Q,V),kt(ctx,1,"30px Papyrus","WHITE","Main Screen",30,40),ctx.restore()}at=!1}function bt(t,e,s,i,h,n,a){t.save(),t.setTransform(1,0,0,1,0,0),t.globalAlpha=e,t.fillStyle=s,t.fillRect(i,h,n,a),t.restore()}function vt(t,e,s,i,h,n,a){var o=eval('"\\u'+h+'"');t.globalAlpha=e,t.font=s,t.fillStyle=i,t.fillText(o,n,a)}function kt(t,e,s,i,h,n,a){t.save(),t.setTransform(1,0,0,1,0,0),t.globalAlpha=e,t.font=s,t.fillStyle=i,t.fillText(h,n,a),t.restore()}function St(){return mt.keys&&(mt.keys[It]||mt.keys[Bt])}function Mt(){return mt.keys&&(mt.keys[Nt]||mt.keys[Yt])}function Et(){return mt.keys&&(mt.keys[jt]||mt.keys[Ot])}function Tt(){return mt.keys&&(mt.keys[zt]||mt.keys[Gt])}function At(){return mt.keys&&mt.keys[Ft]}function Ht(){return mt.keys&&mt.keys[Xt]}function Pt(){return mt.keys&&mt.keys[Jt]}function Lt(){return mt.keys&&mt.keys[Qt]}function Rt(){return mt.keys&&mt.keys[Vt]}function Dt(){return mt.keys&&mt.keys[Zt]}function Wt(){return mt.keys&&mt.keys[_t]}function Ct(){ht.set(it.x,it.y),nt.x=it.x-5,nt.y=it.y+5,nt.h=10,nt.w=10}var It=37,Nt=39,jt=38,zt=40,Ot=87,Bt=65,Gt=83,Yt=68,Xt=77,Kt=0,Ut=2,Ft=32,qt=69,Jt=49,Qt=50,Vt=51,Zt=52,$t=82,_t=84,te=0,ee=1,se=2,ie=3,he=4,ne=5,ae=6,oe=7;function re(t,s,i,h,n,a,o,r,c){this.e=new q(t,s,i,h,n,a,"",r,!1,c),this.e.parent=this,this.mtype=o,this.bspd=100,this.spd=.5,this.time=0,this.facing=Nt,this.e.hands.push(new q(4,4,i,h,0,H.HAND,"",r,!1)),this.e.hands.push(new q(4,4,i,h,0,H.HAND,"",r,!1)),this.hit=function(t,e,s){this.e.hp-=1+s},this.update=function(t){this.time+=t/1e3;let s=this.e.x,i=this.e.y;e=this.e;let h=1.7*Math.sin(500*this.time*.008);e.hands[0].y=25+h,e.hands[1].y=25-h,e.hands[0].x=25,e.hands[1].x=15;let n=this.steerFromNearbyMobs(dt.level.mobs,26);if(this.mtype==P.FOLLOW)e.y=i<dt.hero.e.y?i+=this.spd/2+n.y:i+=-this.spd/2+n.y,e.x=s<dt.hero.e.x?s+=this.spd+n.x:s+=-this.spd+n.x;else if(this.mtype==P.RANGED){if(Math.sqrt(Math.pow(this.e.x-dt.hero.e.x,2)+Math.pow(this.e.y-dt.hero.e.y,2))<120){let t=this.e.x-dt.hero.e.x,e=this.e.y-dt.hero.e.y,s=Math.sqrt(t*t+e*e);t/=s,e/=s,this.e.x+=t*this.spd*.8,this.e.y+=e*this.spd*.8}else e.y=i<dt.hero.e.y?i+=this.spd/4+n.y:i+=-this.spd/4+n.y,e.x=s<dt.hero.e.x?s+=this.spd/2+n.x:s+=-this.spd/2+n.x}this.e.x>dt.hero.e.x?this.e.flip=!0:this.e.flip=!1},this.steerFromNearbyMobs=function(t,e){let s=0,i=0,h=0;for(let n=0;n<t.length;n++){let a=t[n],o=Math.sqrt(Math.pow(this.e.x-a.e.x,2)+Math.pow(this.e.y-a.e.y,2));a!==this&&o<e&&(s+=this.e.x-a.e.x,i+=this.e.y-a.e.y,h++)}h>0&&(s/=h,i/=h);let n=Math.sqrt(s*s+i*i);return n>0&&(s/=n,i/=n),{x:s,y:i}}}